<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>사자의 턱 디지털 시트</title>
    <style>
        :root {
            --accent: #c2a35d;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #e0e0e0;
            --border: #333;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        #app { width: 100%; max-width: 500px; background: #1a1a1a; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        button { cursor: pointer; border: none; transition: 0.2s; border-radius: 4px; color: white; }
        input { background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; font-size: 1rem; text-align: center; }

/* [직업 선택 스크린] 가로 밀기 레이아웃 */
.screen { padding: 40px 0; text-align: center; }
.job-list-vertical { display: flex; flex-direction: column; gap: 12px; padding: 0 15px; }

.job-card-v { 
    position: relative; 
    height: 100px; 
    background-color: #252525; 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    overflow: hidden; 
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
    cursor: pointer; 
    display: flex; /* 가로 배치를 위해 추가 */
}

/* 호버 시 카드 확장 */
.job-card-v:hover { 
    height: 170px !important; 
    border-color: var(--accent);
}

/* 캐릭터 이미지 설정 */
.job-character-img {
    height: 100%;
    width: 100%; 
    object-fit: cover;
    /* [중요] 처음에는 이미지의 중앙(50%)을 기준으로 보여줌 */
    object-position: 50% center; 
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    z-index: 1;
}

/* 호버 시: 왼쪽으로 밀려나며 가로폭이 줄어들 때 */
.job-card-v:hover .job-character-img {
    width: 45%; /* 왼쪽 영역으로 폭이 줄어듦 */
    
    /* [핵심] 폭이 줄어들 때 이미지의 기준점(포커스)을 이동시킵니다.
       처음엔 50%(중앙)였던 포커스를 유지하거나 살짝 조정하여 
       이미지의 오른쪽이 잘려 나가는 동안 캐릭터 중심을 계속 붙잡아둡니다.
    */
    object-position: 50% center; 
}

/* 텍스트 우측 정렬 오버레이 */
.card-overlay {
    position: absolute;
    top: 0; right: 0;
    width: 100%; height: 100%;
    display: flex;
    flex-direction: row; 
    justify-content: flex-end; 
    background: linear-gradient(to right, transparent 0%, rgba(0,0,0,0.8) 70%);
    z-index: 2;
}

/* 직업 정보 - 우측 상단 */
.job-info-row {
    width: 55%; 
    display: flex; 
    flex-direction: column; 
    justify-content: flex-start; 
    align-items: flex-end; 
    padding: 15px 20px;
    box-sizing: border-box;
}

/* 입력 영역 - 우측 하단 */
.input-area { 
    position: absolute;
    right: 0;
    bottom: 20px;
    width: 55%; 
    display: none; 
    padding: 0 20px;
    box-sizing: border-box;
    animation: fadeInRight 0.4s ease forwards;
}

@keyframes fadeInRight {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.job-card-v:not(.occupied):hover .input-area { 
    display: block !important; 
}

/* 호버 시 기존 태그(선택 가능) 숨김 */
.job-card-v:not(.occupied):hover .player-tag-v {
    opacity: 0;
}

.underline-input {
    background: none !important;
    border: none !important;
    border-bottom: 2px solid var(--accent) !important;
    border-radius: 0 !important;
    padding: 8px 0 !important;
    width: 100%;
    outline: none;
    color: white;
    font-size: 1rem;
    text-align: right;
}

.btn-confirm-mini {
    background: var(--accent);
    color: black;
    font-size: 0.7rem;
    font-weight: bold;
    padding: 6px 10px;
    border-radius: 4px;
    margin-top: 8px;
    float: right;
    border: none;
    cursor: pointer;
}

.job-card-v.occupied { border-color: var(--accent); }
.next-lv-txt { font-size: 0.65rem; color: var(--accent); font-weight: bold; }
        /* [상세 캐릭터 시트] */
        .modal-full { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: var(--bg); 
    z-index: 3000; /* 이 부분은 상점 열기 전이라 괜찮습니다 */
    display: flex; 
    flex-direction: column; 
}


        .sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #1a1a1a; border-bottom: 2px solid var(--accent); }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .header-right-group { display: flex; align-items: center; gap: 2px; }
        .name-txt { font-size: 1rem; font-weight: bold; margin-right: 5px; }
        .header-icons-wrap button { background: none; font-size: 1.1rem; padding: 4px; }

        .sheet-main-info { display: flex; width: 100%; border-bottom: 1px solid var(--border); }
       .job-image-area { 
    width: 50%; 
    height: 350px; /* 180px에서 350px로 대폭 늘렸습니다. 필요에 따라 더 조절하세요. */
    background: #252525; 
    border-right: 1px solid var(--border); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow: hidden; /* 이미지가 영역 밖으로 나가지 않게 방지 */
}

#sheet-character-portrait {
    height: 100%;
    width: auto;
    object-fit: contain;
    padding: 10px; /* 이미지 끝이 잘리지 않게 살짝 여백 */
}
        .stats-area { width: 50%; padding: 12px; display: flex; flex-direction: column; gap: 15px; justify-content: center; }
        
        .stat-item { display: flex; flex-direction: column; gap: 4px; }
        .stat-label { font-size: 0.7rem; color: #888; font-weight: bold; }


	/* 아이템 카드 스타일 */
.item-card {
    background: #252525;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 8px;
    cursor: pointer;
}
.item-card.sold-out { filter: grayscale(1) brightness(0.6); cursor: default; }
.item-card .card-top { display: flex; justify-content: space-between; align-items: flex-start; }
.item-card .item-no { font-size: 0.65rem; color: var(--accent); font-weight: bold; }
.item-card .sold-out-tag { color: #ff4444; font-weight: bold; font-size: 0.8rem; }
.item-card .item-name { font-size: 0.95rem; font-weight: bold; }
.item-card .item-price { text-align: center; color: #ffd700; font-weight: bold; font-size: 1.1rem; margin: 5px 0; }
.item-card .card-bottom { display: flex; justify-content: space-between; align-items: center; }
.item-card .stock-info { font-size: 0.75rem; color: #888; }
.owner-tags { display: flex; gap: 3px; }
.owner-tag { font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; color: black; font-weight: bold; }
.tag-적위 { background: #ff4444; }
.tag-도끼 { background: #ffbb00; }
.tag-철거 { background: #44ff44; }
.tag-공허 { background: #aa44ff; }
        
.js-category-bar button.active {
    background: var(--accent) !important;
    color: black !important;
    font-weight: bold;
}
        /* 기존 스타일과 충돌 방지를 위해 접두사 'js-' (Jaws of the Lion) 사용 */


/* [최종 교정] 팝업 위치 및 숨김 설정 */
.js-popup-overlay { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: #121212; /* var(--bg) 대신 직접 지정 */
    z-index: 9999; /* 가장 위로 올림 */
    display: none; /* 기본적으로 아예 제거 */
    flex-direction: column;
}

/* 팝업이 열릴 때만 보이게 하는 클래스 */
.js-popup-overlay.active {
    display: flex !important;
}
.js-popup-header { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 10px 15px; border-bottom: 2px solid var(--accent); 
    background: #1a1a1a; flex-shrink: 0; 
}
.js-category-bar { 
    display: flex; gap: 5px; padding: 10px; overflow-x: auto; 
    background: #222; border-bottom: 1px solid var(--border); flex-shrink: 0; 
}
.js-category-bar button { 
    background: #333; padding: 5px 10px; font-size: 0.7rem; 
    white-space: nowrap; border-radius: 4px; color: white;
}
.js-scroll-content { flex: 1; overflow-y: auto; padding: 15px; }
.js-popup-footer { 
    padding: 10px 15px; border-top: 1px solid var(--border); 
    display: flex; justify-content: space-between; align-items: center; 
    background: #1a1a1a; flex-shrink: 0; 
}
        
        .exp-line { display: flex; align-items: center; gap: 8px; }
        .exp-input { width: 33.3%; height: 32px; }
        .exp-bar-wrap { width: 66.6%; display: flex; align-items: center; gap: 4px; }
        .exp-bar-bg { flex: 1; height: 8px; background: #333; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .exp-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.3s; }

        .gold-line { display: flex; gap: 5px; align-items: center; }
        .gold-input { width: 33.3%; height: 32px; }
        .btn-mini { width: 33.3%; height: 32px; background: #2a2a2a; border: 1px solid var(--accent); font-size: 0.7rem; font-weight: bold; }

        .sheet-menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
        .menu-tab { padding: 18px 5px; background: var(--card-bg); font-weight: bold; font-size: 0.8rem; }

        /* [모달 공통 디자인] */
        .modal-overlay, .modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); /* 85% 투명도의 검은색 */
    display: flex; align-items: center; justify-content: center;
    z-index: 10001;
}
       .modal-content {
    background: #252525 !important; /* 흰색 대신 짙은 회색 */
    color: #e0e0e0 !important;    /* 글자색을 밝은 회색으로 */
    padding: 30px; 
    border-radius: 12px;
    max-width: 320px; 
    width: 90%; 
    text-align: center;
    border: 2px solid var(--accent) !important; /* 강조색 테두리 */
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* 입체감 부여 */
}
        .btn-confirm { background: var(--accent); color: black; padding: 12px; font-weight: bold; flex: 1; }
        .btn-cancel { background: #444; padding: 12px; flex: 1; }

@keyframes unlock-glow {
    0% { box-shadow: 0 0 5px #ffd700; }
    50% { box-shadow: 0 0 20px #ffd700; }
    100% { box-shadow: 0 0 5px #ffd700; }
}

#modal-unlock-success .modal-content {
    animation: unlock-glow 2s infinite ease-in-out;
}

/* 모달 본체: 검은색 바탕 시트와 통일 */
#reward-modal .modal-content {
    background-color: #1a1a1a !important; /* 어두운 배경 */
    border: 2px solid #444 !important;
    color: white !important;
    padding: 20px;
}

/* 내부 완료 문구 & 보상 칸 (연한 녹색 박스) */
.success-box {
    background-color: #d4edda !important; /* 연한 녹색 배경 */
    border: 2px solid #c3e6cb !important;
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    color: #155724 !important; /* 진한 녹색 글씨 (가독성) */
    text-align: center;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
}

/* 강조 텍스트 */
.success-box b {
    color: #1b5e20 !important;
    font-size: 1.1rem;
}

/* 모달 안의 제목 스타일 */
#reward-modal h3 {
    color: #1b5e20 !important;
    margin-top: 0;
    font-weight: bold;
}

/* 특혜 및 이벤트 팝업 스타일 */
.perk-point-control {
    display: flex; justify-content: space-between; align-items: center;
    background: #2a2a2a; padding: 12px; border-radius: 8px; margin-bottom: 15px;
    border: 1px solid var(--accent);
}
.stepper { display: flex; align-items: center; gap: 15px; }
.stepper button { width: 30px; height: 30px; background: var(--accent); color: black; font-weight: bold; font-size: 1.2rem; }

.battle-goal-section { background: #222; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
.battle-goal-boxes { display: flex; gap: 10px; margin-top: 8px; justify-content: center; }
.bg-box {
    width: 35px; height: 35px; border: 2px solid #555; border-radius: 4px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.bg-box.checked { background: var(--accent); border-color: var(--accent); color: black; font-weight: bold; }

.perk-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #333; }
.perk-check-container { display: flex; gap: 4px; flex-shrink: 0; }
.perk-check { width: 18px; height: 18px; border: 1px solid var(--accent); cursor: pointer; }
.perk-check.checked { background: var(--accent); position: relative; }
.perk-check.checked::after { content: '✔'; font-size: 12px; color: black; display: flex; justify-content: center; }
.perk-txt { font-size: 0.85rem; line-height: 1.4; color: #ccc; }
.icon { display: inline-block; width: 14px; vertical-align: middle; margin: 0 2px; }

/* 특혜 설명 내의 텍스트형 아이콘 전용 */
.icon {
    display: inline-block;
    width: auto;             /* 가로 제한 해제 */
    min-width: 14px;
    height: 1.2em;
    line-height: 1.2;
    padding: 1px 4px;
    margin: 0 2px;
    font-size: 0.75rem;
    vertical-align: middle;
    border-radius: 3px;
    white-space: nowrap;
    text-align: center;
    font-weight: bold;
    color: white;           /* 글자색은 흰색 고정 */
}


/* 공통 알림 모달 텍스트 스타일 */
#alert-title {
    color: #ffcc00 !important; /* 제목을 밝은 금색으로 */
    font-size: 1.3rem;
    text-shadow: 0 0 10px rgba(255, 204, 0, 0.4);
    margin-bottom: 15px;
}

#alert-msg {
    color: #ffffff !important; /* 본문은 순백색으로 */
    line-height: 1.6;
    font-size: 1rem;
}

/* 보상과 보물 강조를 위한 클래스 (JS에서 활용) */
.highlight-reward {
    color: #ffcc00; /* 금색 */
    font-weight: bold;
    font-size: 1.1rem;
}

.highlight-treasure {
    color: #4a90e2; /* 파란색 */
    font-weight: bold;
}

/* 다시 잠금 버튼 스타일 */
.btn-reset {
    background: none;
    border: 1px solid #555;
    color: #888;
    font-size: 0.7rem;
    padding: 2px 5px;
    cursor: pointer;
    border-radius: 3px;
    transition: 0.2s;
}
.btn-reset:hover {
    background: #c0392b;
    color: white;
    border-color: #c0392b;
}

/* 색상은 클래스별로 동일하게 적용 */
.icon.status { background-color: #A29BFE; }
.icon.poison { background-color: #819e7a; }
.icon.wound  { background-color: #e67e22; }
.icon.fire   { background-color: #E74C3C; }
.icon.ice    { background-color: #3498db; }
.icon.air    { background-color: #74b9ff; }
.icon.earth  { background-color: #795548; }
.icon.light  { background-color: #f1c40f; color: black; } /* 빛만 검은글씨 */
.icon.dark   { background-color: #2c3e50; }
.icon.curse  { background-color: #4b4b4b; color: #a29bfe; }
.icon.immob  { background-color: #4b4b4b; color: #e74c3c; }
.icon.heal { background-color: #27ae60; }
.icon.stun { background-color: #FFFAFA; color: blue; }

body, .screen {
    background-color: #1a1a1a; /* 시트와 동일한 어두운 배경 */
    color: #e0e0e0;
    margin: 0;
    min-height: 100vh;
}

/* 시나리오 그리드 가독성 향상 */
.screen.hidden {
    display: none !important; /* 확실하게 숨김 */
}

/* 시나리오 그리드 다크 테마 */
#scenario-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    padding: 20px;
    background: #1a1a1a;
}

/* 시나리오 카드 다크 디자인 */
.scenario-card {
    background: #2a2a2a; /* 카드 배경도 어둡게 */
    border: 1px solid #444;
    border-radius: 12px;
    padding: 20px;
    color: #eee;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}

.scenario-card.locked {
    background: #222;
    opacity: 0.4;
    border: 1px dashed #555;
}

/* 완료된 시나리오 카드 전용 스타일 */
.scenario-card.completed {
    border: 2px solid #ffb84d !important; /* 선명한 금색 테두리 */
    background: linear-gradient(145deg, #2d241e, #1a1a1a) !important; /* 약간의 갈색 빛이 도는 다크톤 */
    box-shadow: 0 0 15px rgba(255, 184, 77, 0.2); /* 은은한 금색 광원 효과 */
}

/* 보상 태그 가독성 향상 */
.reward-tag {
    display: block;
    margin-top: 8px;
    padding: 6px 10px;
    background: #333; /* 어두운 배경 */
    color: #ffcc00 !important; /* 진한 노란색 (금색) */
    font-weight: bold;
    border-radius: 4px;
    border-left: 3px solid #ffcc00; /* 왼쪽에 포인트 선 */
}

/* 완료 텍스트 */
.status-completed {
    color: #2ecc71 !important; /* 아주 선명한 녹색 */
    font-weight: 800;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

/* 모달 스타일 */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: white; padding: 30px; border-radius: 15px;
    max-width: 400px; width: 90%; text-align: center;
    border: 5px solid #8b4513;
}

/* 어떤 상황에서도 hidden 클래스가 붙으면 화면에서 지워버림 */
.screen.hidden, section.hidden {
    display: none !important;
}

/* 전체 배경을 검은색으로 고정하여 잔상 방지 */
html, body {
    background-color: #000;
}


/* 도시 이벤트 관리 창 정중앙 배치 */
#screen-city-event {
    /* 1. 부모(#app) 내부에서 위치 기준 잡기 */
    position: absolute !important; 
    top: 0;
    left: 50% !important;
    transform: translateX(-50%); /* 정확히 가로 중앙으로 당김 */

    /* 2. 너비 고정 */
    width: 100% !important;
    max-width: 500px !important;
    height: 100%;
    
    /* 3. 기타 스타일 */
    background: #1a1a1a;
    z-index: 10;
    margin: 0 !important; /* absolute 상태에선 margin 0이 안전함 */
    padding: 0 !important; /* 상단 헤더가 딱 붙도록 */
    text-align: left;
    box-sizing: border-box;
}

/* 내부 레이아웃이 밀리지 않도록 고정 */
#screen-city-event > div {
    width: 100% !important;
    max-width: 500px !important;
    box-sizing: border-box !important;
}

/* 스크린이 표시될 때만 보이게 설정 */
#screen-city-event.hidden {
    display: none !important;
}
#screen-city-event:not(.hidden) {
    display: block !important;
}

    </style>
</head>
<body>


<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <div id="app">
      <section id="screen-home" class="screen">
    <h1 style="font-family: 'Cinzel', serif; color: var(--accent); letter-spacing: 5px; margin-top: 50px; text-align: center; line-height: 1.2;">
    GLOOMHAVEN<br>
    <span style="font-size: 0.5em; letter-spacing: 8px; color: #888; font-weight: 400;">JAWS OF THE LION</span>
</h1>
    <div style="margin-top: 80px; display: flex; flex-direction: column; gap: 12px; align-items: center;">
        <button class="btn-confirm" style="width: 240px; padding: 15px;" onclick="openModal('modal-party-name')">새 파티 만들기</button>
        
        <button style="background: #333; width: 240px; padding: 12px; color: white; border: none; border-radius: 8px; cursor: pointer;" 
                onclick="document.getElementById('party-list').classList.toggle('hidden'); renderPartyList();">
            기존 파티 목록
        </button>

        <ul id="party-list" style="list-style: none; padding: 0; background: var(--card-bg); width: 240px; border: 1px solid var(--border); border-radius: 8px; margin-top: 5px; overflow-y: auto; max-height: 200px;">
            </ul>
    </div>
</section>

<section id="screen-job-select" class="screen hidden" style="padding: 20px 0;">
    <h2 id="display-party-name" style="color: var(--accent); font-size: 1.1rem; margin-bottom: 15px; padding: 0 20px; text-align: center;">파티이름</h2>
    
    <div class="job-list-vertical" id="job-list-container" style="padding: 0 20px;">
        <script>
            // 여기서는 카드 생성에 필요한 정보만 선언
            const imgMap = { "적위병": "rg1", "도끼투척수": "hc1", "철거전문가": "dm1", "공허감시자": "vw1" };
            const jobsList = ['적위병', '도끼투척수', '철거전문가', '공허감시자'];

            jobsList.forEach(job => {
                const selectImgUrl = `${imgMap[job]}.jpg`; 
                const isOccupied = (typeof charData !== 'undefined' && charData[job] && charData[job].playerName);

                document.write(`
                    <div class="job-card-v ${isOccupied ? 'occupied' : ''}" id="card-${job}" 
                         onclick="handleJobClick(event, '${job}')">
                        <img src="${selectImgUrl}" class="job-character-img" alt="${job}">
                        <div class="card-overlay">
                            <div class="job-info-row">
                                <span class="job-name-v" style="font-weight: bold; font-size: 1.2rem; color: var(--accent);">${job}</span>
                                <span class="player-tag-v" id="tag-${job}" style="margin-top: 5px; font-size: 0.8rem; color: #ccc;">
                                    ${isOccupied ? charData[job].playerName : '선택 가능'}
                                </span>
                            </div>
                            ${!isOccupied ? `
                            <div class="input-area" onclick="event.stopPropagation()">
                                <input type="text" id="input-${job}" class="underline-input" placeholder="이름 입력" autocomplete="off">
                                <button class="btn-confirm-mini" onclick="confirmPlayerName('${job}')">확인</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `);
            });

            // 클릭 시 JS 파일에 있는 openDetailSheet를 호출함
            function handleJobClick(e, job) {
                const card = document.getElementById(`card-${job}`);
                if (card.classList.contains('occupied')) {
                    if (typeof openDetailSheet === 'function') {
                        openDetailSheet(job);
                    }
                }
            }
        </script>
    </div>

    <button onclick="showScreen('screen-home')" style="color:#666; background:none; border:none; margin-top:20px; font-size:0.8rem; width:100%; cursor:pointer;">
        ← 처음으로 돌아가기
    </button>
</section>

 <section id="screen-scenario" class="screen hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; padding: 20px; background:#222; border-bottom:1px solid #333;">
            <h2 style="color:var(--accent); margin:0; font-size:1.2rem;">📜 캠페인 시나리오</h2>
            <button onclick="showScreen('screen-job-select'); openModal('modal-char-sheet');" 
                    style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer;">
                🔙 캐릭터 시트로
            </button>
        </div>
        <div id="scenario-grid"></div>
    </section>


 <div id="modal-char-sheet" class="modal-full hidden">
    <header class="sheet-header">
        <div class="header-left">
            <span id="sheet-job-name" style="color:var(--accent); font-weight:bold;">직업</span>
            <span style="color:var(--accent); font-size:0.8rem;">LV<span id="sheet-lv-num">1</span></span>
        </div>
        <div class="header-right-group">
            <span id="sheet-player-name" class="name-txt">이름</span>
            <div class="header-icons-wrap">
                <button onclick="openNameEditModal()">✏️</button>
                <button onclick="closeModal('modal-char-sheet')">⬅️</button>
                <button onclick="openModal('modal-reset-confirm')">❌</button>
            </div>
        </div>
    </header>

    <div class="sheet-main-info">
        <div class="job-image-area" style="display: flex; justify-content: center; align-items: center; overflow: hidden; background: rgba(0,0,0,0.1); border-radius: 8px;">
            <img id="sheet-character-portrait" src="" alt="캐릭터 전신" 
                 style="max-height: 100%; width: auto; object-fit: contain; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));">
        </div>
        
        <div class="stats-area">
            <div class="party-status-bar" onclick="openDifficultyModal()" style="cursor:pointer; background:rgba(255,255,255,0.05); border:1px solid #333; border-radius:8px; padding:8px 12px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; transition:0.2s;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:1.1rem;">💀</span>
                    <span style="font-size:0.75rem; color:#888; letter-spacing:1px;">PARTY LV.</span>
                    <b id="header-scenario-lv" style="color:var(--accent); font-family:monospace; font-size:1rem;">1</b>
                </div>
                <div style="font-size:0.6rem; color:#555; border-left:1px solid #333; padding-left:10px;">
                    난이도 확인
                </div>
            </div>

            <div class="stat-item">
                <div class="stat-label">EXP (총량 / 획득량)</div>
                <div class="exp-line" style="display: flex; gap: 8px;">
                    <input type="number" id="input-exp" class="exp-input" style="flex: 1; background: #222;" readonly>
                    <input type="number" id="add-exp-input" class="exp-input" style="flex: 1; border: 1px solid #444;" 
                           placeholder="획득량" onblur="addStatOnBlur('exp')" autocomplete="off">
                </div>
                <div class="exp-bar-wrap" style="display: flex; align-items: center; gap: 8px; margin-top: 8px; width: 100%;">
                    <div class="exp-bar-bg" style="flex: 1; height: 12px; background: #333; border-radius: 6px; overflow: hidden;">
                        <div id="exp-fill" class="exp-bar-fill" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s ease;"></div>
                    </div>
                    <span id="next-lv-info" class="next-lv-txt" style="min-width: 25px; text-align: right; font-weight: bold; color: var(--accent);">2</span>
                </div>
            </div>

            <div class="stat-item" style="margin-top: 15px;">
                <div class="stat-label">GOLD (총량 / 획득량)</div>
                <div class="gold-line" style="display: flex; gap: 8px;">
                    <input type="number" id="input-gold" class="gold-input" style="flex: 1; background: #222;" readonly>
                    <input type="number" id="add-gold-input" class="gold-input" style="flex: 1; border: 1px solid #444;" 
                           placeholder="획득량" onblur="addStatOnBlur('gold')" autocomplete="off">
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button class="btn-mini" style="flex: 1; height: 35px;" onclick="openShop()">🛒 상점</button>
                    <button class="btn-mini" style="flex: 1; height: 35px;" onclick="openBag()">🎒 가방</button>
                </div>
            </div>
        </div> 
    </div>

    <div class="sheet-menu-grid">
        <button class="menu-tab" onclick="openPerkPopup()">특혜</button>
        <button class="menu-tab" onclick="closeModal('modal-char-sheet'); showScreen('screen-scenario'); renderScenarios();">시나리오</button>
        <button class="menu-tab" onclick="openCityEventMode()">도시이벤트</button>
    </div>
</div>

<div id="modal-difficulty" class="modal hidden" style="z-index: 11000; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; justify-content:center; align-items:center; backdrop-filter: blur(2px);">
    <div class="modal-content" style="width:90%; max-width:340px; border:1px solid var(--accent); background:#1a1a1a; padding:20px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            <h3 style="margin:0; color:var(--accent); font-size:1rem; letter-spacing:1px;">SCENARIO SETTING</h3>
            <span onclick="closeDifficultyModal()" style="cursor:pointer; font-size:1.2rem; color:#888;">&times;</span>
        </div>

        <div id="party-avg-info" style="display:flex; background:#222; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.75rem; color:#aaa; text-align:center;">
            <div style="flex:1;">평균 레벨 <br><b id="val-avg-lv" style="color:#eee; font-size:0.9rem;">0.0</b></div>
            <div style="width:1px; background:#444; margin:0 10px;"></div>
            <div style="flex:1;">기준 난이도 <br><b id="val-base-lv" style="color:var(--accent); font-size:0.9rem;">0</b></div>
        </div>

        <style>
            .diff-selector-row { display: flex; gap: 4px; margin-bottom: 20px; background: #111; padding: 4px; border-radius: 8px; border: 1px solid #333; }
            .diff-btn { 
                flex: 1; border: none; background: transparent; color: #666; 
                padding: 8px 0; font-size: 0.65rem; border-radius: 5px; cursor: pointer; transition: 0.2s;
                white-space: nowrap;
            }
            .diff-btn.active { background: var(--accent); color: white; font-weight: bold; box-shadow: 0 0 10px var(--accent); }
        </style>
        
        <div class="diff-selector-row">
            <button class="diff-btn" onclick="calcDifficulty(-1, this)">쉬움</button>
            <button class="diff-btn active" onclick="calcDifficulty(0, this)">보통</button>
            <button class="diff-btn" onclick="calcDifficulty(1, this)">어려움</button>
            <button class="diff-btn" onclick="calcDifficulty(2, this)">악몽</button>
            <button class="diff-btn" onclick="calcDifficulty(3, this)">지옥</button>
        </div>

        <div id="difficulty-results" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; background:rgba(255,255,255,0.03); padding:12px; border-radius:8px; border: 1px solid #333;">
            <div class="result-item" style="display:flex; flex-direction:column; align-items:center; border-right: 1px solid #333;">
                <span style="font-size:0.6rem; color:#666; margin-bottom:3px;">몬스터 레벨</span>
                <b id="res-monster" style="font-size:1.1rem; color:var(--accent);">1</b>
            </div>
            <div class="result-item" style="display:flex; flex-direction:column; align-items:center;">
                <span style="font-size:0.6rem; color:#666; margin-bottom:3px;">골드 배수</span>
                <b id="res-coin" style="font-size:1.1rem; color:#ffd700;">x2</b>
            </div>
            <div class="result-item" style="display:flex; flex-direction:column; align-items:center; border-right: 1px solid #333; margin-top:5px; padding-top:5px; border-top: 1px solid #333;">
                <span style="font-size:0.6rem; color:#666; margin-bottom:3px;">함정 피해</span>
                <b id="res-trap" style="font-size:1.1rem; color:#ff4444;">3</b>
            </div>
            <div class="result-item" style="display:flex; flex-direction:column; align-items:center; margin-top:5px; padding-top:5px; border-top: 1px solid #333;">
                <span style="font-size:0.6rem; color:#666; margin-bottom:3px;">추가 경험치</span>
                <b id="res-xp" style="font-size:1.1rem; color:#44ff44;">+2</b>
            </div>
        </div>
    </div>
</div>

        <div id="modal-party-name" class="modal hidden">
    <div class="modal-content">
        <h3>파티 이름 입력</h3>
        <input type="text" id="input-party-name" style="width:90%; padding:10px; margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button class="btn-confirm" onclick="confirmPartyName()">확인</button>
            <button class="btn-cancel" onclick="closeModal('modal-party-name')">취소</button>
        </div>
    </div>
</div>

        <div id="modal-name-edit" class="modal hidden">
            <div class="modal-content">
                <h3>이름 수정</h3>
                <input type="text" id="input-edit-name" style="width:90%; padding:10px; margin-bottom:15px;">
                <div style="display:flex; gap:10px;">
                    <button class="btn-confirm" onclick="confirmNameEdit()">저장</button>
                    <button class="btn-cancel" onclick="closeModal('modal-name-edit')">취소</button>
                </div>
            </div>
        </div>

        <div id="modal-reset-confirm" class="modal hidden">
            <div class="modal-content">
                <h3 style="color:#ff4444">데이터 초기화</h3>
                <p>모든 정보가 삭제됩니다.</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn-confirm" style="background:#ff4444" onclick="executeReset()">진행</button>
                    <button class="btn-cancel" onclick="closeModal('modal-reset-confirm')">취소</button>
                </div>
            </div>
        </div>
    </div>

<div id="popup-shop" class="js-popup-overlay">
            <header class="js-popup-header">
                <span style="color:var(--accent); font-weight:bold;">🛒 상점</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="color:#ffd700; font-size:0.9rem;">GOLD: <span class="current-gold-display">0</span>G</span>
                    <button onclick="closePopup('popup-shop')" style="background:none; font-size:1.2rem; color:white;">✕</button>
                </div>
            </header>
            <div class="js-category-bar">
    <button onclick="renderShopItems('전체')" class="active">전체</button>
    <button onclick="renderShopItems('투구')">투구</button>
    <button onclick="renderShopItems('갑옷')">갑옷</button>
    <button onclick="renderShopItems('무기')">무기</button>
    <button onclick="renderShopItems('신발')">신발</button>
    <button onclick="renderShopItems('소모품')">소모품</button>
</div>
            <div class="js-scroll-content" id="shop-item-list">
                <p style="color:#666; text-align:center; margin-top:50px;">상점이 비어있습니다.</p>
            </div>
            <footer class="js-popup-footer">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:0.75rem; color:#888;">해금:</span>
                    <input type="text" style="width:50px; height:25px; font-size:0.8rem;" placeholder="No.">
                    <button class="btn-confirm" style="padding:4px 8px; font-size:0.7rem;" onclick="unlockItem()">확인</button>
                </div>
                <button onclick="closePopup('popup-shop'); openBag();" style="background:#333; width:40px; height:40px; border:1px solid var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center;">🎒</button>
            </footer>
        </div>

<div id="popup-bag" class="js-popup-overlay">
    <header class="js-popup-header">
        <span style="color:var(--accent); font-weight:bold;">🎒 가방</span>
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="color:#ffd700; font-size:0.9rem;">GOLD: <span class="current-gold-display">0</span>G</span>
            <button onclick="closePopup('popup-bag')" style="background:none; font-size:1.2rem; color:white;">✕</button>
        </div>
    </header>
    
    <div class="js-category-bar">
    <button onclick="renderBagItems('전체')" class="active">전체</button>
    <button onclick="renderBagItems('투구')">투구</button>
    <button onclick="renderBagItems('갑옷')">갑옷</button>
    <button onclick="renderBagItems('무기')">무기</button>
    <button onclick="renderBagItems('신발')">신발</button>
    <button onclick="renderBagItems('소모품')">소모품</button>
</div>
        <div class="js-scroll-content" id="bag-item-list">
        <p style="color:#666; text-align:center; margin-top:50px;">소지한 아이템이 없습니다.</p>
    </div>

    <footer class="js-popup-footer" style="justify-content: flex-end;">
        <button onclick="closePopup('popup-bag'); openShop();" style="background:#333; width:40px; height:40px; border:1px solid var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center;">🛒</button>
    </footer>
</div>

<div id="modal-item-action" class="modal hidden">
    <div class="modal-content">
        <h3 id="action-item-name" style="color:var(--accent); margin-top:0;">아이템 이름</h3>
        <p id="action-item-price" style="color:#ffd700; margin-bottom:20px;">0G</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn-confirm" onclick="processItemAction('buy')">💰 골드로 구매</button>
            <button class="btn-confirm" style="background:#4a90e2; color:white;" onclick="processItemAction('reward')">🎁 보상으로 획득</button>
            <button class="btn-cancel" onclick="closeModal('modal-item-action')">취소</button>
        </div>
    </div>
</div>

<div id="modal-delete-confirm" class="modal hidden">
    <div class="modal-content">
        <h3 id="delete-item-name" style="color:#ff4444; margin-top:0;">아이템 삭제</h3>
        <p style="color:#e0e0e0; margin-bottom:20px;">삭제하시겠습니까?</p>
        <div style="display:flex; gap:10px;">
            <button class="btn-confirm" style="background:#ff4444" onclick="executeDelete()">삭제</button>
            <button class="btn-cancel" onclick="closeModal('modal-delete-confirm')">취소</button>
        </div>
    </div>
</div>

<div id="modal-trade-select" class="modal hidden">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0;">아이템 거래</h3>
        <p id="trade-item-info" style="font-size:0.9rem; margin-bottom:15px; color:#888;">#01 독수리 눈 고글</p>
        <p style="color:#e0e0e0; margin-bottom:20px;">누구와 거래하시겠습니까?</p>
        <div id="trade-job-list" style="display:flex; flex-direction:column; gap:10px;">
            </div>
        <button class="btn-cancel" style="width:100%; margin-top:15px;" onclick="closeModal('modal-trade-select')">취소</button>
    </div>
</div>

<div id="modal-unlock-success" class="modal hidden">
    <div class="modal-content" style="border-color: #ffd700; background: linear-gradient(145deg, #1e1e1e, #2a2a2a);">
        <div style="font-size: 2rem; margin-bottom: 10px;">✨</div>
        <h3 id="unlock-item-title" style="color:#ffd700; margin: 0 0 10px 0; letter-spacing: 1px;">#00 아이템 해금!</h3>
        <p id="unlock-item-desc" style="color:#e0e0e0; font-size: 1.1rem; margin-bottom: 25px; font-weight: bold;">아이템 이름</p>
        <button class="btn-confirm" style="width: 100%; box-shadow: 0 0 10px rgba(194,163,93,0.3);" onclick="closeModal('modal-unlock-success')">상점에서 확인하기</button>
    </div>
</div>

<div id="popup-perks" class="js-popup-overlay">
    <header class="js-popup-header">
        <span style="color:var(--accent); font-weight:bold;">📜 특혜 (Perks)</span>
        <button onclick="closePopup('popup-perks')" style="background:none; font-size:1.2rem; color:white;">✕</button>
    </header>
    <div class="js-scroll-content">
        <div class="perk-point-control">
            <span>특혜 포인트</span>
            <div class="stepper">
                <button onclick="changePerkPoint(-1)">-</button>
                <span id="display-perk-points" style="color:var(--accent); font-weight:bold;">0</span>
                <button onclick="changePerkPoint(1)">+</button>
            </div>
        </div>
        <div class="battle-goal-section">
            <span style="font-size:0.8rem; color:#888;">배틀 골 달성 (3칸 채울 시 포인트 +1)</span>
            <div class="battle-goal-boxes" id="battle-goal-container"></div>
        </div>
        <div id="perk-list-container"></div>
    </div>
</div>

<div id="popup-event" class="js-popup-overlay">
    <header class="js-popup-header">
        <span id="event-popup-title" style="color:var(--accent); font-weight:bold;">시나리오 결과</span>
        <button onclick="closePopup('popup-event')" style="background:none; font-size:1.2rem; color:white;">✕</button>
    </header>
    <div class="js-scroll-content" style="text-align:center;">
        <p id="event-intro">번호를 입력하세요.</p>
        <div style="margin:20px 0; display:flex; justify-content:center; gap:10px;">
            <input type="number" id="event-num-input" style="width:80px; height:40px;" placeholder="No.">
            <button class="btn-confirm" style="flex:none; width:60px;" onclick="checkEventResult()">확인</button>
        </div>
        <div id="event-result-display" style="padding:15px; background:#222; border-radius:8px; line-height:1.6; display:none;"></div>
    </div>
</div>
	
<div id="modal-perk-success" class="modal hidden">
    <div class="modal-content" style="border-color: #ffd700; animation: unlock-glow 2s infinite ease-in-out;">
        <div style="font-size: 2.5rem; margin-bottom: 10px;">⭐</div>
        <h3 style="color:#ffd700; margin: 0 0 10px 0; letter-spacing: 1px;">특혜 포인트 획득!</h3>
        <p id="perk-success-msg" style="color:#ffd700; font-size: 1rem; line-height: 1.5; margin-bottom: 25px;">
            배틀 골 3칸을 모두 채워<br>특혜 포인트가 1 증가했습니다.
        </p>
        <button class="btn-confirm" style="width: 100%;" onclick="closeModal('modal-perk-success')">확인</button>
    </div>
</div>

<div id="modal-common-alert" class="modal hidden">
    <div class="modal-content">
        <h3 id="alert-title" style="color:var(--accent); margin-top:0; font-size: 1.1rem;">안내</h3>
        <p id="alert-msg" style="color:#e0e0e0; margin-bottom:25px; font-size: 0.95rem; line-height: 1.4;"></p>
        <button class="btn-confirm" style="width:100%;" onclick="closeModal('modal-common-alert')">확인</button>
    </div>
</div>

<div id="reward-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:white; padding:25px; border-radius:15px; max-width:400px; width:90%; text-align:center; border:4px solid #8b4513; color:#333;">
        <div id="modal-body" style="margin-bottom:20px;"></div>
        <button class="btn-confirm" onclick="document.getElementById('reward-modal').style.display='none'">확인</button>
    </div>
</div>

<div id="modal-scenario-manage" class="modal hidden" style="z-index: 2000;">
    <div class="modal-content" style="background-color: #1a1a1a !important; border: 2px solid #444 !important; max-width: 350px;">
        <h3 id="manage-title" style="color: #ff4d4d !important; margin-bottom: 15px;">⚠️ 상태 변경</h3>
        <div id="manage-msg" style="margin-bottom: 20px;">
            </div>
        <div style="display: flex; gap: 10px;">
            <button id="btn-manage-confirm" class="btn-confirm" style="flex: 1; background: #c0392b;">확인</button>
            <button onclick="closeModal('modal-scenario-manage')" style="flex: 1; background: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">취소</button>
        </div>
    </div>
</div>	

<div id="modal-unlock-confirm" class="modal hidden">
    <div class="modal-content" style="background-color: #1a1a1a !important; border: 2px solid var(--accent) !important; max-width: 350px;">
        <h3 style="color: var(--accent) !important; margin-bottom: 15px;">🔓 시나리오 해금</h3>
        
        <div id="unlock-confirm-text" style="color: #e0e0e0; margin-bottom: 25px; font-size: 0.95rem; line-height: 1.5; text-align: center;">
            해당 시나리오를 새로운 여정으로<br>추가하시겠습니까?
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="btn-unlock-execute" class="btn-confirm" style="flex: 1; background: var(--accent);">확인</button>
            <button onclick="closeModal('modal-unlock-confirm')" style="flex: 1; background: #444; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">취소</button>
        </div>
    </div>
</div>

<div id="modal-delete-party-confirm" class="modal hidden">
    <div class="modal-content" style="border-color: #ff4444 !important;">
        <h3 style="color: #ff4444;">파티 삭제</h3>
        <p id="delete-party-msg" style="margin-bottom: 20px; line-height: 1.5;">
            이 파티를 삭제하시겠습니까?<br>
            <span style="font-size: 0.8rem; color: #888;">(삭제된 데이터는 복구할 수 없습니다.)</span>
        </p>
        <div style="display:flex; gap:10px;">
            <button class="btn-confirm" id="btn-party-delete-final" style="background: #ff4444;">삭제하기</button>
            <button class="btn-cancel" onclick="closeModal('modal-delete-party-confirm')">취소</button>
        </div>
    </div>
</div>


<section id="screen-city-event" class="screen hidden" style="width: 100%; max-width: 500px;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding: 20px; background:#222; border-bottom:1px solid #333;">
        <h2 style="color:var(--accent); margin:0; font-size:1.2rem;">🏙️ 도시 이벤트 관리</h2>
        <button onclick="showScreen('screen-job-select'); openModal('modal-char-sheet');" 
                style="background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:5px; cursor:pointer; font-weight:bold;">
            🔙 캐릭터 시트로
        </button>
    </div>

    <div style="padding: 20px; width: 100%; box-sizing: border-box;">
        <div class="scenario-card completed" style="margin-bottom: 20px; background: #1a1a1a; padding: 15px; border-left: 5px solid var(--accent);">
            <div style="margin-bottom: 12px;">
                <b style="color:var(--accent); font-size:0.9rem;">✅ 현재 덱</b> <span id="deck-count" style="color:#888; font-size:0.8rem;"></span>
                <div id="deck-numbers" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>
            <div style="margin-bottom: 12px;">
                <b style="color:#ff6b6b; font-size:0.9rem;">🚫 소멸 덱</b> <span id="removed-count" style="color:#888; font-size:0.8rem;"></span>
                <div id="removed-numbers" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>
            <div>
                <b style="color:#555; font-size:0.9rem;">🔒 잠김 덱</b> <span id="locked-count" style="color:#888; font-size:0.8rem;"></span>
                <div id="locked-numbers" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>
        </div>

        <div style="background:#252525; padding:15px; border-radius:12px; border:1px solid #444; margin-bottom:20px;">
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="number" id="input-event-id" placeholder="번호" style="width:60px; padding:10px; background:#1a1a1a; border:1px solid #444; color:#fff; border-radius:6px; text-align:center;">
                <input type="text" id="input-event-note" placeholder="사건 결과 요약" style="flex:1; padding:10px; background:#1a1a1a; border:1px solid #444; color:#fff; border-radius:6px;">
            </div>
            <div style="display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 8px;">
                <button onclick="handleEventAction('toggle')" style="background:#444; color:#fff; padding:10px 0; border-radius:6px; font-weight:bold; font-size:0.85rem;">해금/잠금</button>
                <button onclick="handleEventAction('remove')" style="background:#c0392b; color:#fff; padding:10px 0; border-radius:6px; font-weight:bold; font-size:0.85rem;">소멸</button>
                <button onclick="handleEventAction('bottom')" style="background:#2980b9; color:#fff; padding:10px 0; border-radius:6px; font-weight:bold; font-size:0.85rem;">복귀</button>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:#888; font-size:0.9rem; margin:0;">📜 최근 기록</h3>
            <button onclick="toggleAllLogs()" id="btn-toggle-logs" style="background:none; border:1px solid var(--accent); color:var(--accent); font-size:0.7rem; padding:2px 8px; border-radius:4px; cursor:pointer;">전체 기록 보기</button>
        </div>
        <div id="latest-log-container"></div>
        <div id="all-logs-container" class="hidden" style="max-height:250px; overflow-y:auto; margin-top:10px; border-top:1px solid #333; padding-top:10px;"></div>
    </div>
</section>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>



<script>

const firebaseConfig = {
  apiKey: "AIzaSyB4uSsNsrb44niEckclKnxPCFa8CRxs40c",
  authDomain: "gh-jotl.firebaseapp.com",
  databaseURL: "https://gh-jotl-default-rtdb.firebaseio.com",
  projectId: "gh-jotl",
  storageBucket: "gh-jotl.firebasestorage.app",
  messagingSenderId: "467051482347",
  appId: "1:467051482347:web:1247b5c52fcd37685602ae"
};

  // 파이어베이스 초기화
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();





    // 레벨업 테이블 (경험치 기준)
    const lvTable = [0, 45, 95, 150, 210, 275, 345, 420, 500];

    
let charData = {
    '적위병': { 
        playerName: '', exp: 0, gold: 0, lv: 1, inventory: [], 
        perkPoints: 0, 
        battleGoals: [false, false, false], 
        checkedPerks: {} 
    },
    '도끼투척수': { 
        playerName: '', exp: 0, gold: 0, lv: 1, inventory: [], 
        perkPoints: 0, 
        battleGoals: [false, false, false], 
        checkedPerks: {} 
    },
    '철거전문가': { 
        playerName: '', exp: 0, gold: 0, lv: 1, inventory: [], 
        perkPoints: 0, 
        battleGoals: [false, false, false], 
        checkedPerks: {} 
    },
    '공허감시자': { 
        playerName: '', exp: 0, gold: 0, lv: 1, inventory: [], 
        perkPoints: 0, 
        battleGoals: [false, false, false], 
        checkedPerks: {} 
    }
};
	const itemData = [
    { id: 1, name: "독수리 눈 고글", price: 30, stock: 2, type: "투구", owners: [] },
    { id: 2, name: "철 투구", price: 20, stock: 2, type: "투구", owners: [] },
    { id: 3, name: "쇠사슬 갑옷", price: 30, stock: 2, type: "갑옷", owners: [] },
    { id: 4, name: "징 박은 가죽 갑옷", price: 25, stock: 2, type: "갑옷", owners: [] },
    { id: 5, name: "낡은 장화", price: 15, stock: 2, type: "신발", owners: [] },
    { id: 6, name: "날개 달린 신발", price: 15, stock: 2, type: "신발", owners: [] },
    { id: 7, name: "다리미꼴 방패", price: 20, stock: 2, type: "무기", owners: [] },
    { id: 8, name: "투척용 망치", price: 30, stock: 2, type: "무기", owners: [] },
    { id: 9, name: "독 단검", price: 20, stock: 2, type: "무기", owners: [] },
    { id: 10, name: "강철 창", price: 20, stock: 2, type: "무기", owners: [] },
    { id: 11, name: "치료 물약", price: 10, stock: 2, type: "소모품", owners: [] },
    { id: 12, name: "활력 물약", price: 10, stock: 2, type: "소모품", owners: [] },
    { id: 13, name: "힘 물약", price: 10, stock: 2, type: "소모품", owners: [] },
    { id: 14, name: "마나 물약", price: 10, stock: 2, type: "소모품", owners: [] },
    { id: 15, name: "생명의 부적", price: 20, stock: 1, type: "소모품", owners: [] },
    { id: 16, name: "초혼의 로브", price: 40, stock: 1, type: "갑옷", owners: [] },
    { id: 17, name: "편안한 신발", price: 30, stock: 1, type: "신발", owners: [] },
    { id: 18, name: "전투 도끼", price: 25, stock: 1, type: "무기", owners: [] },
    { id: 19, name: "검은 양초", price: 40, stock: 1, type: "무기", owners: [] },
    { id: 20, name: "기절 가루", price: 20, stock: 2, type: "소모품", owners: [] },
    { id: 21, name: "송골매 투구", price: 20, stock: 1, type: "투구", owners: [] },
    { id: 22, name: "날붙이 갑옷", price: 45, stock: 1, type: "갑옷", owners: [] },
    { id: 23, name: "활보의 장화", price: 30, stock: 1, type: "신발", owners: [] },
    { id: 24, name: "휘발성 폭탄", price: 40, stock: 1, type: "무기", owners: [] },
    { id: 25, name: "가시 돋친 사슬", price: 30, stock: 1, type: "무기", owners: [] },
    { id: 26, name: "떡갈나무 부적", price: 30, stock: 2, type: "소모품", owners: [] },
    { id: 27, name: "운명 나침반", price: 25, stock: 1, type: "소모품", owners: [] },
    { id: 28, name: "벼룩투성이 숄", price: 10, stock: 1, type: "갑옷", owners: [] },
    { id: 29, name: "대형 방패", price: 40, stock: 1, type: "무기", owners: [] },
    { id: 30, name: "신속의 반지", price: 40, stock: 1, type: "소모품", owners: [] },
    { id: 31, name: "힘의 반지", price: 40, stock: 1, type: "소모품", owners: [] },
    { id: 32, name: "회복의 반지", price: 40, stock: 1, type: "소모품", owners: [] },
    { id: 33, name: "강철 반지", price: 30, stock: 1, type: "소모품", owners: [] },
    { id: 34, name: "가시 돋친 도끼", price: 40, stock: 1, type: "무기", owners: [] },
    { id: 35, name: "명령의 로브", price: 40, stock: 1, type: "갑옷", owners: [] },
    { id: 36, name: "제트 장화", price: 30, stock: 1, type: "신발", owners: [] }
];

let scenarios = {
    1: { title: "길 가던 중의 습격", state: "unlocked", reward: "없음", unlockItem: null, treasure: "없음", next: [2], locks: [], treasureOwner: null },
    2: { title: "구멍 난 벽", state: "locked", reward: "각 +25G, 아이템 1~13 해금", unlockItem: [1,2,3,4,5,6,7,8,9,10,11,12,13], treasure: [{ id: 14, content: "🪙x3",owner: null}], next: [3], locks: [], treasureOwner: null },
    3: { title: "검은 배", state: "locked", reward: "각 1특혜포인트", unlockItem: null, treasure: "없음", next: [4], locks: [], treasureOwner: null },
    4: { title: "의식의 장소", state: "locked", reward: "아이템 14 해금", unlockItem: 14, treasure: [{ id: 16, content: "#14 마나 포션",owner: null}], next: [5], locks: [], treasureOwner: null },
    5: { title: "썩어가는 은신처", state: "locked", reward: "각 +25exp", unlockItem: null, treasure: [{ id: 9, content: "+5G",owner: null}], next: [6], locks: [], treasureOwner: null },
    6: { title: "공포의 유적", state: "locked", reward: "각 1특혜포인트", unlockItem: null, treasure: "없음", next: [7,8], locks: [], treasureOwner: null },
    7: { title: "지하 감옥", state: "locked", reward: "각 +20exp", unlockItem: null, treasure: [{ id: 12, content: "+5G",owner: null}], next: [9], locks: [8], treasureOwner: null },
    8: { title: "자유로운 변절자", state: "locked", reward: "없음", unlockItem: null, treasure: [{ id: 4, content: "+5G",owner: null}], next: [9], locks: [7], treasureOwner: null },
    9: { title: "폭발하는 기계", state: "locked", reward: "각 +20exp,아이템 15~20 해금", unlockItem: [15,16,17,18,19,20], treasure: [{ id: 1, content: "+10exp",owner: null}], next: [10], locks: [], treasureOwner: null },
    10: { title: "가려진 태양", state: "locked", reward: "각 +15exp", unlockItem: null, treasure: [{ id: 8, content: "피해3, 중독",owner: null}], next: [11,12], locks: [], treasureOwner: null },
    11: { title: "부서진 집단", state: "locked", reward: "#28 벼룩투성이 숄", unlockItem: 28, treasure: "없음", next: [13,19], locks: [12], treasureOwner: null },
    12: { title: "하수도 쥐", state: "locked", reward: "#28 벼룩투성이 숄", unlockItem: 28, treasure: "없음", next: [14,18], locks: [11], treasureOwner: null },
    13: { title: "피의 의식", state: "locked", reward: "아이템 30 해금", unlockItem: 30, treasure: [{ id: 5, content: "+10G",owner: null}], next: [15], locks: [], treasureOwner: null },
    14: { title: "그림자 습격", state: "locked", reward: "각 1특혜포인트", unlockItem: null, treasure: [{ id: 15, content: "1특혜포인트",owner: null}], next: [15], locks: [], treasureOwner: null },
    15: { title: "타오르는 숲", state: "locked", reward: "각 +10G, 아이템 21~26 해금", unlockItem: [21,22,23,24,25,26], treasure: "없음", next: [16], locks: [], treasureOwner: null },
    16: { title: "유독한 가스", state: "locked", reward: "각 +15exp, #29 대형 방패", unlockItem: 29, treasure: "없음", next: [17], locks: [], treasureOwner: null },
    17: { title: "잊혀진 동굴", state: "locked", reward: "각 +25exp, +30G", unlockItem: null, treasure: [{ id: 3, content: "+15exp",owner: null}], next: [], locks: [], treasureOwner: null },
    18: { title: "버려진 실험실", state: "locked", reward: "각 +10exp", unlockItem: null, treasure: [{ id: 2, content: "#31 힘의 반지", owner: null }, { id: 6, content: "+10G", owner: null },{ id: 7, content: "+5G", owner: null },{ id: 13, content: "+5G", owner: null }], next: [], locks: [], treasureOwner: null },
    19: { title: "최후의 보루", state: "locked", reward: "#31 힘의 반지", unlockItem: 31, treasure: "없음", next: [], locks: [], treasureOwner: null },
    20: { title: "심연의 부름", state: "locked", reward: "각 +10G", unlockItem: null, treasure: [{ id: 99, content: "#32 회복의 반지",owner: null}], next: [], locks: [], treasureOwner: null },
    21: { title: "붉은 안개", state: "locked", reward: "각 +15G", unlockItem: null, treasure: [{ id: 11, content: "#30 신속의 반지",owner: null}], next: [], locks: [], treasureOwner: null },
    22: { title: "파멸의 서막", state: "locked", reward: "#33 강철 반지", unlockItem: 33, treasure: "없음", next: [], locks: [], treasureOwner: null },
    23: { title: "혼돈의 도가니", state: "locked", reward: "#34 가시 돋친 도끼", unlockItem: 34, treasure: "없음", next: [], locks: [], treasureOwner: null },
    24: { title: "고대의 부름", state: "locked", reward: "#35 명령의 로브", unlockItem: 35, treasure: "없음", next: [], locks: [], treasureOwner: null },
    25: { title: "사자의 턱", state: "locked", reward: "#36 제트 장화", unlockItem: 36, treasure: "없음", next: [], locks: [], treasureOwner: null }
};
	
	
	
	let unlockedItemIds = [];
        let activeExpandedJob = null;
        let currentJob = '';
	let parties = JSON.parse(localStorage.getItem('gloomhaven_parties')) || [];
	let currentPartyIndex = null; 
	let isLocalUpdate = false; 


// [통합 및 수정된 파티 생성 함수]
function confirmPartyName() {
    console.log("파티 생성 프로세스 시작");
    const input = document.getElementById('input-party-name');
    const name = input.value.trim();
    
    if (!name) {
        alert("파티 이름을 입력해주세요.");
        return;
    }

    // 1. 새 파티 데이터 객체 생성 (기존 charData, scenarios 참조)
    // 주의: 전역에 charData와 scenarios 기본값이 반드시 있어야 합니다.
    const newParty = {
        partyName: name,
        characters: JSON.parse(JSON.stringify(charData)), 
        scenarios: JSON.parse(JSON.stringify(scenarios)),
        unlockedItems: [] // 아이템 해금 정보도 파티별로 관리하려면 추가
    };
Object.keys(newParty.characters).forEach(job => {
        if (!newParty.characters[job].perks) {
            newParty.characters[job].perks = {}; 
        }
    });

    // 2. 배열에 추가 및 인덱스 설정
    if (!Array.isArray(parties)) parties = []; // 방어 코드
    parties.push(newParty);
    currentPartyIndex = parties.length - 1;

    // 3. UI 업데이트
    document.getElementById('display-party-name').innerText = name;
    
    // 4. 저장 (로컬 + 서버)
    saveAllParties(); 
    
    // 5. 정리 및 화면 이동
    input.value = '';
    closeModal('modal-party-name');
    renderPartyList(); // 목록 갱신
    
    // 6. 바로 해당 파티의 직업 선택 화면으로 진입
    selectParty(currentPartyIndex);
    
    console.log("파티 생성 및 서버 전송 시도 완료");
}


function renderPartyList() {
    const listContainer = document.getElementById('party-list');
    if (!listContainer) return;
    listContainer.innerHTML = '';

    if (parties.length === 0) {
        listContainer.innerHTML = '<li style="padding: 15px; color: #666; font-size: 0.8rem; text-align: center;">생성된 파티가 없습니다.</li>';
        return;
    }

    parties.forEach((party, index) => {
        const li = document.createElement('li');
        li.style = "display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);";
        li.innerHTML = `
            <div onclick="selectParty(${index})" style="padding: 15px; color: var(--accent); flex: 1; cursor: pointer; font-size: 0.9rem;">
                🏰 ${party.partyName}
            </div>
            <div onclick="deleteParty(${index})" style="padding: 15px; color: #ff4444; cursor: pointer; font-weight: bold; font-size: 1.1rem;">
                ✕
            </div>
        `;
        listContainer.appendChild(li);
    });
}

function selectParty(index) {
    // 1. 현재 선택된 파티 인덱스를 전역 변수에 저장 (가장 중요)
    currentPartyIndex = index;
    
    const selected = parties[index];
    
    // 2. 전역 데이터 변수를 선택된 파티의 데이터로 완전 교체
    // (데이터가 없을 경우를 대비해 기본값 {}를 설정합니다)
    charData = selected.characters || {};
    scenarios = selected.scenarios || {};
    unlockedItemIds = selected.unlockedItemIds || [];

    // 3. UI 갱신
    document.getElementById('display-party-name').innerText = selected.partyName;
    
    // 4. 화면 전환
    showScreen('screen-job-select');

    // 5. [추가] 진입 시점에 캐릭터 카드 UI 강제 동기화
    // 이 코드가 있어야 폰에서도 이름이 즉시 보입니다.
    Object.keys(charData).forEach(job => {
        if (typeof syncJobCard === 'function') {
            syncJobCard(job);
        }
    });

    renderScenarios();
    console.log(`[${selected.partyName}] 파티 진입 완료 (Index: ${index})`);
}

let partyIndexToDelete = null; // 삭제 대상을 잠시 저장할 변수

// 1. 삭제 모달을 띄우는 함수
function deleteParty(index) {
    partyIndexToDelete = index; // 삭제할 인덱스 저장
    const partyName = parties[index].partyName;
    
    // 모달 안의 문구 변경
    document.getElementById('delete-party-msg').innerHTML = 
        `🏰 <b style="color:var(--accent)">${partyName}</b> 파티를<br>정말 삭제하시겠습니까?`;
    
    // 삭제 버튼에 클릭 이벤트 연결 (한 번만 등록되도록 처리)
    const deleteBtn = document.getElementById('btn-party-delete-final');
    deleteBtn.onclick = executePartyDelete; 
    
    openModal('modal-delete-party-confirm');
}

// 2. 실제로 삭제를 실행하는 함수
function executePartyDelete() {
    if (partyIndexToDelete !== null) {
        // 만약 삭제하려는 파티가 현재 내가 보고 있는 파티라면 인덱스 초기화
        if (currentPartyIndex === partyIndexToDelete) {
            currentPartyIndex = null;
        } else if (currentPartyIndex > partyIndexToDelete) {
            // 삭제된 항목보다 뒤에 있는 파티를 보고 있었다면 인덱스 하나 당김
            currentPartyIndex--;
        }

        parties.splice(partyIndexToDelete, 1); // 배열에서 삭제
        saveAllParties();     // 서버/로컬 저장
        renderPartyList();    // 목록 갱신
        
        closeModal('modal-delete-party-confirm');
        partyIndexToDelete = null; // 변수 초기화
        
        if (typeof showAlert === 'function') {
            showAlert("삭제 완료", "파티가 안전하게 삭제되었습니다.");
        }
    }
}

function saveAllParties() {
    // [추가] 현재 선택된 파티가 있다면, 메모리상의 최신 데이터(charData, scenarios)를 배열에 업데이트
    if (currentPartyIndex !== null && parties[currentPartyIndex]) {
        parties[currentPartyIndex].characters = charData;
        parties[currentPartyIndex].scenarios = scenarios;
    }

    // 1. 기존처럼 로컬스토리지에도 저장 (백업용)
    localStorage.setItem('gloomhaven_parties', JSON.stringify(parties));

    // 2. 파이어베이스 서버에 저장 (실시간 동기화)
    if (typeof database !== 'undefined') {
        database.ref('parties/').set(parties)
        .then(() => {
            console.log("서버 저장 완료!");
        })
        .catch((error) => {
            console.error("서버 저장 실패:", error);
        });
    }
}
function showScreen(id) {
    // 1. 'screen' 혹은 'section' 태그를 가진 모든 요소를 찾아서 숨김
    const allScreens = document.querySelectorAll('.screen, section');
    allScreens.forEach(s => {
        s.classList.add('hidden'); // 클래스 추가
        s.style.display = 'none';  // 인라인 스타일로 한 번 더 확실히!
    });

    // 2. 우리가 보여주고 싶은 대상만 노출
    const target = document.getElementById(id);
    if (target) {
        target.classList.remove('hidden');
        target.style.display = 'flex'; // 혹은 'block'
        target.style.flexDirection = 'column';
    }
    
    // 3. 화면 전환 시 항상 맨 위로 스크롤
    window.scrollTo(0, 0);
}
function openModal(id) { 
    const modal = document.getElementById(id);
    if (modal) modal.classList.remove('hidden'); 
}

function closeModal(id) { 
    const modal = document.getElementById(id);
    if (modal) modal.classList.add('hidden'); 
}

        // [이름 수정 모달 처리]
        function openNameEditModal() {
            document.getElementById('input-edit-name').value = charData[currentJob].playerName;
            openModal('modal-name-edit');
        }

        function confirmNameEdit() {
            const newName = document.getElementById('input-edit-name').value.trim();
            if(!newName) return;
            charData[currentJob].playerName = newName;
            document.getElementById('sheet-player-name').innerText = newName;
            syncJobCard(currentJob);
            closeModal('modal-name-edit');
        }

        // [자동 레벨업 로직]
        function handleExpInput(val) {
            const exp = parseInt(val) || 0;
            charData[currentJob].exp = exp;
            
            // 현재 경험치에 맞는 레벨 계산
            let level = 1;
            for(let i=1; i<lvTable.length; i++) {
                if(exp >= lvTable[i-1]) level = i;
            }
            
            charData[currentJob].lv = level;
            updateSheetUI(exp, level);
        }

function updateSheetUI(exp, level) {
    document.getElementById('sheet-lv-num').innerText = level;
    const minExp = lvTable[level-1];
    const maxExp = lvTable[level] || 500;
    const nextLv = (level < 9) ? level + 1 : 'MAX'; 

    document.getElementById('next-lv-info').innerText = ` ${nextLv} (${maxExp})`;
    
    const range = maxExp - minExp;
    const progress = ((exp - minExp) / range) * 100;
    document.getElementById('exp-fill').style.width = Math.min(Math.max(progress, 0), 100) + "%";
}

// === 추가: 파티 레벨 계산 함수 ===
function updateDifficultyBar() {
    // charData에서 플레이어 이름이 있는(활성화된) 캐릭터만 필터링
    const characters = Object.values(charData).filter(c => c.playerName);
    if (characters.length === 0) return;

    const totalLv = characters.reduce((sum, c) => sum + (parseInt(c.lv) || 1), 0);
    const avg = totalLv / characters.length;
    const scenarioLv = Math.ceil(avg / 2); // 평균 레벨의 절반 (올림)

    const headerLv = document.getElementById('header-scenario-lv');
    if (headerLv) headerLv.innerText = scenarioLv;
}
// [추가] 난이도 설정 모달 열기
function openDifficultyModal() {
    // 1. 먼저 파티 레벨을 최신화함
    updateDifficultyBar();
    
    // 2. 현재 화면에 표시된 시나리오 레벨(해골 옆 숫자)을 가져옴
    const currentScenarioLv = parseInt(document.getElementById('header-scenario-lv').innerText) || 1;
    
    // 3. 모달 안의 '기본 시나리오 레벨' 정보 업데이트
    const valBaseLv = document.getElementById('val-base-lv');
    const valAvgLv = document.getElementById('val-avg-lv');
    
    // 평균 레벨 재계산 (표시용)
    const characters = Object.values(charData).filter(c => c.playerName);
    const totalLv = characters.reduce((sum, c) => sum + (parseInt(c.lv) || 1), 0);
    const avg = characters.length > 0 ? (totalLv / characters.length).toFixed(1) : "0.0";
    
    if(valAvgLv) valAvgLv.innerText = avg;
    if(valBaseLv) valBaseLv.innerText = currentScenarioLv;

    // 4. 난이도 계산기 실행 (보통 난이도 0 기준으로 초기화)
    if (typeof calcDifficulty === 'function') {
        calcDifficulty(0); 
    }

    // 5. 모달 표시
    openModal('modal-difficulty');
}

// [추가] 난이도 설정 모달 닫기
function closeDifficultyModal() {
    closeModal('modal-difficulty');
}

// [추가] 난이도 수치 계산 로직
function calcDifficulty(diff, btn) {
    const baseLv = parseInt(document.getElementById('header-scenario-lv').innerText) || 1;
    const targetLv = Math.max(0, baseLv + diff); // 레벨은 0 미만으로 내려가지 않음

    // 버튼 활성화 스타일 변경
    if (btn) {
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // 결과값 계산 (글룸헤이븐 기준 예시 수치)
    document.getElementById('res-monster').innerText = targetLv;
    document.getElementById('res-coin').innerText = `x${targetLv <= 0 ? 2 : (targetLv >= 7 ? 6 : Math.floor(targetLv/2) + 2)}`;
    document.getElementById('res-trap').innerText = targetLv + 2; // 단순 예시 수치
    document.getElementById('res-xp').innerText = `+${targetLv * 2 + 4}`; // 단순 예시 수치
}

        // [기타 핸들러]
        function handleJobClick(event, job) {
            if (charData[job].playerName) {
                currentJob = job;
                openDetailSheet(job);
                return;
            }
            const card = document.getElementById('card-' + job);
            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                activeExpandedJob = null;
            } else {
                if (activeExpandedJob) document.getElementById('card-' + activeExpandedJob).classList.remove('expanded');
                card.classList.add('expanded');
                activeExpandedJob = job;
                document.getElementById('input-' + job).focus();
            }
        }

     function confirmPlayerName(job) {
    const inputEl = document.getElementById('input-' + job);
    if (!inputEl) return;
    
    const name = inputEl.value.trim();
    if (!name) return;

    // 데이터 저장
    charData[job].playerName = name;
    currentJob = job;
    
    // UI 반영
    syncJobCard(job);
    const card = document.getElementById('card-' + job);
    if (card) card.classList.remove('expanded');
    
    // [핵심] 저장 함수명을 saveAllData로 통일
    if (typeof saveAllData === 'function') {
        saveAllData();
    }

    // 상세 시트 열기
    openDetailSheet(job);
}

function openDetailSheet(job) {
    const data = charData[job];
    if (!data) return;
currentJob = job;

    // 1. 파일명 매칭 (카드용 rg1 -> 시트용 rg)
    const imgMap = { "적위병": "rg1", "도끼투척수": "hc1", "철거전문가": "dm1", "공허감시자": "vw1" };
    const baseName = imgMap[job] || "default";
    const sheetFileName = baseName.slice(0, -1); 
    const sheetImgUrl = `${sheetFileName}.jpg`; 
    
    // 2. [수정] 이미 준비된 이미지 칸(ID: sheet-character-portrait)에 주소만 전달
    const portraitImg = document.getElementById('sheet-character-portrait');
    if (portraitImg) {
        portraitImg.src = sheetImgUrl;
        // 만약 기존 구조가 <img>가 아니라 <div> 배경이라면 아래 주석을 해제하세요.
        // portraitImg.style.backgroundImage = `url('${sheetImgUrl}')`;
    }

    // 3. 나머지 정보 업데이트
    document.getElementById('sheet-job-name').innerText = job;
    document.getElementById('sheet-player-name').innerText = data.playerName || "이름 없음";
    
    const expInput = document.getElementById('input-exp');
    const goldInput = document.getElementById('input-gold');
    if (expInput) expInput.value = data.exp || 0;
    if (goldInput) goldInput.value = data.gold || 0;

    if (typeof handleExpInput === 'function') {
        handleExpInput(data.exp || 0);
    }
    updateDifficultyBar();
    openModal('modal-char-sheet');
}

	    function syncJobCard(job) {
    const tag = document.getElementById('tag-' + job);
    const card = document.getElementById('card-' + job);
    if (!tag || !card) return;

    const name = charData[job].playerName;

    // 1. 이름 글자 표시 (없으면 '선택 가능')
    tag.innerText = name || '선택 가능';

    if (name) {
        // 2. 이름이 있는 경우
        card.classList.add('occupied');
        card.classList.remove('expanded'); // ★ 이름이 들어왔으니 입력창을 닫음
    } else {
        // 3. 이름이 없는 경우
        card.classList.remove('occupied');
    }
}

        function saveGold(val) { charData[currentJob].gold = val; }

     function executeReset() {
    if (!currentJob || !charData[currentJob]) return;

    // 1. 메모리 상의 캐릭터 데이터를 '완전 초기 상태'로 초기화
    charData[currentJob] = { 
        playerName: '', 
        exp: 0, 
        gold: 0, 
        lv: 1,
        battleGoals: [false, false, false],
        checkedPerks: {},
        perkPoints: 0,
        items: [] 
    };

    // 2. [가장 중요] 변경된 데이터를 전체 파티 배열(parties)에 즉시 반영
    // 이 작업이 없으면 saveAllData를 불러도 옛날 파티 데이터가 저장됩니다.
    if (currentPartyIndex !== null && parties[currentPartyIndex]) {
        parties[currentPartyIndex].characters = charData;
    }

    // 3. UI 즉시 갱신
    syncJobCard(currentJob);
    if (typeof updateDifficultyBar === 'function') updateDifficultyBar();

    // 4. 서버로 '파티 배열 전체'를 전송 (덮어쓰기)
    // 함수 이름이 saveAllData인지 saveAllParties인지 확인 후 호출하세요!
    if (typeof saveAllData === 'function') {
        saveAllData(); 
        console.log("🔥 서버 데이터 완전 초기화 및 동기화 완료");
    } else if (typeof saveAllParties === 'function') {
        saveAllParties();
    }

    // 5. 모달 및 상세 시트 닫기
    closeModal('modal-reset-confirm');
    closeModal('modal-char-sheet');
}

// [수정] 함수 선언부와 시작 중괄호({)를 명확히 추가했습니다.
function addStatOnBlur(type) {
    if (!currentJob || !charData[currentJob]) return;

    const addInput = document.getElementById(`add-${type}-input`);
    const totalInput = document.getElementById(`input-${type}`);
    
    if (!addInput || !addInput.value) return;

    const addValue = parseInt(addInput.value) || 0;
    if (addValue === 0) {
        addInput.value = "";
        return;
    }

    // 데이터 계산 및 저장
    const currentVal = charData[currentJob][type] || 0;
    const newTotal = currentVal + addValue;
    charData[currentJob][type] = newTotal;

    // UI 업데이트
    if (totalInput) totalInput.value = newTotal;
    addInput.value = ''; 
    
    if (type === 'gold') {
        document.querySelectorAll('.current-gold-display').forEach(el => el.innerText = newTotal);
    }
    
    // 서버 저장
    if (typeof saveAllData === 'function') saveAllData();
} 

// 초기화 시 모든 'add' 입력칸을 강제로 비우는 코드
window.addEventListener('DOMContentLoaded', () => {
    const expIn = document.getElementById('add-exp-input');
    const goldIn = document.getElementById('add-gold-input');
    if (expIn) expIn.value = '';
    if (goldIn) goldIn.value = '';
});

// [통합] 골드 표시 업데이트 함수
function updateGoldDisplay() {
    if (!currentJob || !charData[currentJob]) return;
    const gold = charData[currentJob].gold || 0;
    document.querySelectorAll('.current-gold-display').forEach(el => {
        el.innerText = gold;
    });
}

// [통합] 상점 열기
function openShop() {
    updateGoldDisplay();
    renderShopItems('전체'); 
    document.getElementById('popup-shop').classList.add('active');
}

// [통합] 가방 열기
function openBag() {
    updateGoldDisplay();
    renderBagItems('전체');
    document.getElementById('popup-bag').classList.add('active');
}

// [통합] 팝업 닫기 (상점/가방 전용)
function closePopup(id) {
    document.getElementById(id).classList.remove('active');
}

	let selectedItem = null;

// 아이템 선택 시 모달 열기
function openItemAction(item) {
    selectedItem = item;
    document.getElementById('action-item-name').innerText = item.name;
    document.getElementById('action-item-price').innerText = item.price + "G";
    openModal('modal-item-action');
}

// 구매 또는 획득 처리
function processItemAction(type) {
    const gold = charData[currentJob].gold || 0;
    const itemId = Number(selectedItem.id);
    
    // 1. 골드 체크 및 차감
    if (type === 'buy') {
        if (gold < selectedItem.price) {
            if (typeof showAlert === 'function') {
                showAlert("골드 부족", "구매에 필요한 골드가 부족합니다!");
            } else {
                alert("골드가 부족합니다!");
            }
            return;
        }
        charData[currentJob].gold -= selectedItem.price;
    }

    // 2. 인벤토리 데이터 수정
    if (!charData[currentJob].inventory) charData[currentJob].inventory = [];
    if (!charData[currentJob].inventory.includes(itemId)) {
        charData[currentJob].inventory.push(itemId);
    }

    // 3. [동기화 핵심] 전체 파티 구조에 현재 수정된 charData 반영
    if (currentPartyIndex !== null && parties[currentPartyIndex]) {
        parties[currentPartyIndex].characters = charData;
    }

    // 4. [가장 중요] 서버 저장 함수 호출 (이게 있어야 실시간 동기화가 일어납니다)
    if (typeof saveAllData === 'function') {
        saveAllData();
        console.log(`🔥 아이템 ${type === 'buy' ? '구매' : '획득'} 서버 전송 완료`);
    }

    // 5. UI 갱신 및 알림
    document.getElementById('input-gold').value = charData[currentJob].gold;
    updateGoldDisplay();
    
    if (typeof renderShopItems === 'function') renderShopItems('전체');
    if (typeof renderBagItems === 'function') renderBagItems('전체'); // 내 가방도 갱신
    
    closeModal('modal-item-action');

    if (type === 'buy' && typeof showAlert === 'function') {
        showAlert("구매 성공", `[#${itemId}] ${selectedItem.name}을(를) 구매했습니다!`);
    }
}

// 판매 실행
function processSell() {
    const sellPrice = Math.ceil(selectedItem.price / 2);
    const itemId = Number(selectedItem.id);
    
    charData[currentJob].gold = parseInt(charData[currentJob].gold) + sellPrice;
    
    // [수정] 인벤토리에서 제거
    const idx = charData[currentJob].inventory.indexOf(itemId);
    if (idx > -1) charData[currentJob].inventory.splice(idx, 1);
    
    document.getElementById('input-gold').value = charData[currentJob].gold;
    updateGoldDisplay();
    renderBagItems();
    closeModal('modal-item-action');
    resetModalButtons();
}

function executeTrade(targetJob) {
    if (!itemToTrade) return;

    const itemId = Number(itemToTrade.id);

    // 1. [데이터 수정] 내 인벤토리에서 제거 (가장 중요)
    if (charData[currentJob] && charData[currentJob].inventory) {
        charData[currentJob].inventory = charData[currentJob].inventory.filter(id => Number(id) !== itemId);
    }

    // 2. [데이터 수정] 상대방 인벤토리에 추가 (가장 중요)
    if (!charData[targetJob].inventory) charData[targetJob].inventory = [];
    if (!charData[targetJob].inventory.includes(itemId)) {
        charData[targetJob].inventory.push(itemId);
    }

    // 3. 구 방식 호환을 위한 owners 배열 업데이트 (선택사항)
    if (itemToTrade.owners) {
        const myIdx = itemToTrade.owners.indexOf(currentJob);
        if (myIdx > -1) itemToTrade.owners.splice(myIdx, 1);
        if (!itemToTrade.owners.includes(targetJob)) itemToTrade.owners.push(targetJob);
    }

    // 4. 변경사항 저장 (이게 없으면 새로고침 시 아이템이 돌아옵니다)
    saveAllData();

    if (typeof showAlert === 'function') {
        showAlert(`${targetJob} (${charData[targetJob].playerName})에게 [#${itemId}] 아이템을 전달했습니다!`, "거래 완료");
    }
    
    // 5. UI 새로고침 및 모달 닫기
    closeModal('modal-trade-select');
    renderBagItems('전체');  // 내 가방에서 사라짐
    renderShopItems('전체'); // 상점의 소유주 태그가 바뀜
    itemToTrade = null;
}

// 가방에서 영구 삭제 실행
function executeDelete() {
    if (itemToDelete) {
        const itemId = Number(itemToDelete.id);
        const idx = charData[currentJob].inventory.indexOf(itemId);
        if (idx > -1) charData[currentJob].inventory.splice(idx, 1);
        
        renderBagItems('전체');
        renderShopItems('전체');
        closeModal('modal-delete-confirm');
        itemToDelete = null;
    }
}

// 상점 아이템 렌더링 (최종형)
function renderShopItems(filterType = '전체') {
    const listContainer = document.getElementById('shop-item-list');
    if (!listContainer) return;
    listContainer.innerHTML = '';

    const buttons = document.querySelectorAll('#popup-shop .js-category-bar button');
    buttons.forEach(btn => {
        if (btn.innerText === filterType) btn.classList.add('active');
        else btn.classList.remove('active');
    });

    itemData.sort((a, b) => a.id - b.id); 

    itemData.forEach(item => {
        if (!unlockedItemIds.includes(item.id)) return;
        if (filterType !== '전체' && item.type !== filterType) return;

        // [수정] 실시간 데이터 참조
        const ownership = getItemOwnershipInfo(item.id);
        const isSoldOut = ownership.count >= item.stock;
        const remainingStock = item.stock - ownership.count;

        const card = document.createElement('div');
        card.className = `item-card ${isSoldOut ? 'sold-out' : ''}`;
        
        card.innerHTML = `
            <div class="card-top">
                <div class="item-no">#${String(item.id).padStart(2, '0')}</div>
                ${isSoldOut ? '<span class="sold-out-tag">품절</span>' : ''}
            </div>
            <div class="item-name">${item.name}</div>
            <div class="item-price">${item.price}G</div>
            <div class="card-bottom">
                <div class="stock-info">재고: ${remainingStock}/${item.stock}</div>
                <div class="owner-tags">${ownership.tagsHTML}</div>
            </div>
        `;
        
        if (!isSoldOut) {
            card.onclick = () => openItemAction(item);
        }
        listContainer.appendChild(card);
    });
}


function unlockItem() {
    const input = document.querySelector('#popup-shop footer input');
    const val = input.value.trim();
    if (!val) return;

    // 데이터 동기화를 위한 사전 준비
    if (currentPartyIndex === null || !parties[currentPartyIndex]) {
        showAlert("오류", "선택된 파티가 없습니다.");
        return;
    }

    // 1. 범위 해금 처리 (예: 1-13, 1~13)
    const rangeMatch = val.match(/^(\d+)[-~](\d+)$/);
    if (rangeMatch) {
        const start = parseInt(rangeMatch[1]);
        const end = parseInt(rangeMatch[2]);
        let addedCount = 0;

        for (let i = start; i <= end; i++) {
            if (itemData.some(item => item.id === i) && !unlockedItemIds.includes(i)) {
                unlockedItemIds.push(i);
                addedCount++;
            }
        }
        
        if (addedCount > 0) {
            // [핵심] 저장 전 파티 원본 데이터 업데이트
            parties[currentPartyIndex].unlockedItemIds = unlockedItemIds;
            saveAllData(); 
            renderShopItems('전체');
            showAlert("상점 물품 입고", `<span class="highlight-reward">${start}번~${end}번</span> 아이템 중<br>${addedCount}개의 품목이 해금되었습니다.`);
        } else {
            showAlert("안내", "입력한 범위 내에 새로 해금할 아이템이 없습니다.");
        }
    } 
    // 2. 단일 번호 해금/잠금 토글 처리
    else {
        const itemNo = parseInt(val);
        const item = itemData.find(i => i.id === itemNo);

        if (!item) {
            showAlert("오류", "해당 번호의 아이템을 찾을 수 없습니다.");
            return;
        }

        const index = unlockedItemIds.indexOf(itemNo);
        if (index > -1) {
            // 이미 해금된 상태 -> 잠금 확인
            showAlert(
                "아이템 재잠금", 
                `#${String(itemNo).padStart(2, '0')} <span style="color:var(--accent)">${item.name}</span>을(를)<br>다시 잠그시겠습니까?`, 
                () => {
                    unlockedItemIds.splice(index, 1);
                    // [핵심] 동기화 업데이트
                    parties[currentPartyIndex].unlockedItemIds = unlockedItemIds;
                    saveAllData();
                    renderShopItems('전체');
                }
            );
        } else {
            // 잠긴 상태 -> 해금 실행
            unlockedItemIds.push(itemNo);
            
            // [핵심] 동기화 업데이트
            parties[currentPartyIndex].unlockedItemIds = unlockedItemIds;
            saveAllData();
            renderShopItems('전체');

            // 전용 모달 출력
            document.getElementById('unlock-item-title').innerText = `#${String(item.id).padStart(2, '0')} 아이템 해금!`;
            document.getElementById('unlock-item-desc').innerText = item.name;
            openModal('modal-unlock-success');
        }
    }

    input.value = '';
}

// 가방 아이템 렌더링
function renderBagItems(filterType = '전체') {
    const listContainer = document.getElementById('bag-item-list');
    if (!listContainer) return;
    listContainer.innerHTML = '';

    const buttons = document.querySelectorAll('#popup-bag .js-category-bar button');
    buttons.forEach(btn => {
        if (btn.innerText === filterType) btn.classList.add('active');
        else btn.classList.remove('active');
    });

    itemData.sort((a, b) => a.id - b.id);
    
    // [수정] 현재 직업의 인벤토리에 포함된 아이템만 필터링
    const myItems = itemData.filter(item => 
        charData[currentJob].inventory && charData[currentJob].inventory.includes(item.id)
    );

    if (myItems.length === 0) {
        listContainer.innerHTML = '<p style="color:#666; text-align:center; margin-top:50px;">소지한 아이템이 없습니다.</p>';
        return;
    }

    myItems.forEach(item => {
        if (filterType !== '전체' && item.type !== filterType) return;

        const sellPrice = Math.ceil(item.price / 2);
        const card = document.createElement('div');
        card.className = 'item-card';
        const shortName = currentJob.substring(0, 2);

        card.innerHTML = `
            <div class="card-top">
                <div class="item-no">#${String(item.id).padStart(2, '0')}</div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <div class="trade-btn" onclick="event.stopPropagation(); openTradeModal('${item.id}')" 
                         style="cursor:pointer; font-size:1.1rem;">🤝</div>
                    <div class="delete-btn" onclick="event.stopPropagation(); openDeleteConfirm('${item.id}')" 
                         style="color:#ff4444; font-size:1.2rem; cursor:pointer; line-height:1;">✕</div>
                </div>
            </div>
            <div class="item-name">${item.name}</div>
            <div class="item-price" style="color:#888; font-size:0.8rem;">판매 가치: ${sellPrice}G</div>
            <div class="card-bottom">
                <div class="stock-info">${item.type}</div>
                <div class="owner-tags">
                    <span class="owner-tag tag-${shortName}">${shortName}</span>
                </div>
            </div>
        `;
        
        card.onclick = () => openSellAction(item);
        listContainer.appendChild(card);
    });
}
// [추가] 판매 모달 열기
function openSellAction(item) {
    selectedItem = item;
    const sellPrice = Math.ceil(item.price / 2); // 올림 처리
    
    // 기존 modal-item-action 재활용 또는 내용 수정
    document.getElementById('action-item-name').innerText = `#${item.id} ${item.name}`;
    document.getElementById('action-item-price').innerText = `${sellPrice}G에 판매하시겠습니까?`;
    
    // 버튼 구성 변경 (판매용)
    const actionArea = document.querySelector('#modal-item-action .modal-content div');
    actionArea.innerHTML = `
        <button class="btn-confirm" style="background:#ffbb00; color:black;" onclick="processSell()">💰 판매 확정</button>
        <button class="btn-cancel" onclick="closeModal('modal-item-action'); resetModalButtons();">취소</button>
    `;
    
    openModal('modal-item-action');
}

// [추가] 판매 실행 (골드 증가)
function processSell() {
    const sellPrice = Math.ceil(selectedItem.price / 2);
    const itemId = Number(selectedItem.id);
    
    // 1. 골드 추가
    charData[currentJob].gold = Number(charData[currentJob].gold) + sellPrice;
    
    // [핵심] 2. 인벤토리(가방)에서 실제 제거
    if (charData[currentJob].inventory) {
        charData[currentJob].inventory = charData[currentJob].inventory.filter(id => Number(id) !== itemId);
    }

    // 3. (구 방식 호환용) owners 배열에서도 제거
    if (selectedItem.owners) {
        const idx = selectedItem.owners.indexOf(currentJob);
        if (idx > -1) selectedItem.owners.splice(idx, 1);
    }
    
    // 4. 데이터 저장 및 UI 업데이트
    saveAllData(); 
    document.getElementById('input-gold').value = charData[currentJob].gold;
    updateGoldDisplay();
    renderBagItems();
    renderShopItems(); // 재고 및 태그 갱신
    closeModal('modal-item-action');
    resetModalButtons();
}

// [추가] 가방에서 그냥 삭제 (X 버튼)
function deleteItem(itemId) {
    if(!confirm("골드 환급 없이 가방에서 삭제하시겠습니까?")) return;
    
    const item = itemData.find(i => i.id == itemId);
    const idx = item.owners.indexOf(currentJob);
    if (idx > -1) item.owners.splice(idx, 1);
    
    renderBagItems();
}

// [추가] 모달 닫을 때 버튼 원래대로 (구매용으로) 되돌리기
function resetModalButtons() {
    const actionArea = document.querySelector('#modal-item-action .modal-content div');
    actionArea.innerHTML = `
        <button class="btn-confirm" onclick="processItemAction('buy')">💰 골드로 구매</button>
        <button class="btn-confirm" style="background:#4a90e2; color:white;" onclick="processItemAction('reward')">🎁 보상으로 획득</button>
        <button class="btn-cancel" onclick="closeModal('modal-item-action')">취소</button>
    `;
}

let itemToDelete = null; // 삭제 대상을 임시 저장할 변수

// [삭제 모달 열기]
function openDeleteConfirm(itemId) {
    const item = itemData.find(i => i.id == itemId);
    if (!item) return;
    
    itemToDelete = item;
    document.getElementById('delete-item-name').innerText = `#${item.id} ${item.name}`;
    openModal('modal-delete-confirm');
}
// [삭제 실행]
function executeDelete() {
    if (itemToDelete && currentJob) {
        const itemId = Number(itemToDelete.id);
        
        // 1. [핵심 수정] 현재 캐릭터의 인벤토리 배열에서 해당 아이템 ID를 제거
        if (charData[currentJob] && charData[currentJob].inventory) {
            // filter를 사용하여 해당 ID만 제외한 새로운 배열을 할당합니다.
            charData[currentJob].inventory = charData[currentJob].inventory.filter(id => Number(id) !== itemId);
        }

        // 2. [선택 사항] 만약 itemData의 owners 배열도 유지하고 싶다면 (없어도 무방)
        if (itemToDelete.owners) {
            const ownerIdx = itemToDelete.owners.indexOf(currentJob);
            if (ownerIdx > -1) itemToDelete.owners.splice(ownerIdx, 1);
        }

        // 3. UI 및 데이터 저장
        saveAllData();          // 변경된 charData를 로컬스토리지에 저장
        renderBagItems('전체');  // 내 가방 목록 다시 그리기
        renderShopItems('전체'); // 상점 재고 현황 다시 그리기
        
        closeModal('modal-delete-confirm');
        itemToDelete = null;    // 대기 변수 초기화
    }
}
let itemToTrade = null;

// [거래 모달 열기]
function openTradeModal(itemId) {
    const item = itemData.find(i => i.id == itemId);
    if (!item) return;
    
    itemToTrade = item;
    document.getElementById('trade-item-info').innerText = `#${item.id} ${item.name}`;
    
    const tradeListContainer = document.getElementById('trade-job-list');
    tradeListContainer.innerHTML = ''; // 초기화

    // 전체 직업 중 나(currentJob)를 제외하고, 플레이어 이름이 있는 직업만 추출
    const otherJobs = Object.keys(charData).filter(job => job !== currentJob && charData[job].playerName !== '');

    if (otherJobs.length === 0) {
        tradeListContainer.innerHTML = '<p style="color:#666; font-size:0.8rem;">거래 가능한 다른 캐릭터가 없습니다.</p>';
    } else {
        otherJobs.forEach(job => {
            const btn = document.createElement('button');
            btn.className = 'btn-confirm';
            btn.style.width = '100%';
            btn.style.background = '#333';
            btn.style.border = '1px solid var(--accent)';	
            btn.style.color = 'white';
            // 직업명(플레이어명) 형태로 표시
            btn.innerText = `${job} (${charData[job].playerName})`;
            btn.onclick = () => executeTrade(job);
            tradeListContainer.appendChild(btn);
        });
    }

    openModal('modal-trade-select');
}


// 실시간으로 특정 아이템을 소유한 캐릭터들의 태그 HTML과 소유자 수를 반환
function getItemOwnershipInfo(itemId) {
    let tagsHTML = '';
    let count = 0;
    const idNum = Number(itemId);

    Object.keys(charData).forEach(job => {
        const char = charData[job];
        if (char.playerName && char.inventory && char.inventory.includes(idNum)) {
            const shortName = job.substring(0, 2);
            tagsHTML += `<span class="owner-tag tag-${shortName}">${shortName}</span>`;
            count++;
        }
    });
    return { tagsHTML, count };
}	


//특혜밑으로

// 1. 특혜 데이터 (D)
const perkData = {
    "도끼투척수": [{n:2, t:"'-1' 카드 2장을 제거"}, {n:1, t:"'0' 카드 1장을 '+2 <span class='icon status'>혼란</span>' 카드 1장으로 교체"}, {n:1, t:"'0' 카드 1장을 '+1 <span class='icon poison'>중독</span>' 카드 1장으로 교체"}, {n:1, t:"'0' 카드 1장을 '+1 <span class='icon wound'>부상</span>' 카드 1장으로 교체"}, {n:1, t:"'0' 카드 1장을 '+1 <span class='icon immob'>이동불가</span>' 카드 1장으로 교체"}, {n:1, t:"'0' 카드 1장을 '+1 [밀기 2]' 카드 1장으로 교체"}, {n:1, t:"'0' 카드 1장을 '+0 <span class='icon stun'>기절</span>' 카드 1장으로 교체"}, {n:1, t:"'+1' 카드 1장을 '+1 <span class='icon stun'>기절</span>' 카드 1장으로 교체"}, {n:3, t:"'+2 <span class='icon air'>공기</span>' 카드 1장을 추가"}, {n:3, t:"'+1' 카드 1장을 '+3' 카드 1장으로 교체"}],
    "적위병": [{n:1, t:"'0' 카드 4장을 제거"}, {n:1, t:"'-1' 카드 2장을 제거"}, {n:1, t:"'-2' 카드 1장 및 '+1' 카드 1장을 제거"}, {n:2, t:"'-1' 카드 1장을 '+1' 카드 1장으로 교체"}, {n:2, t:"'+1' 카드 1장을 '+2 <span class='icon fire'>불</span>' 카드 1장으로 교체"}, {n:2, t:"'+1' 카드 1장을 '+2 <span class='icon light'>빛</span>' 카드 1장으로 교체"}, {n:2, t:"'+1 <span class='icon fire'>불</span>,<span class='icon light'>빛</span>' 카드 1장을 추가"}, {n:2, t:"'+1 [방어 1] <span class='icon shield'>🛡️</span>' 카드 1장을 추가"}, {n:1, t:"'0' 카드 1장을 '+1 <span class='icon immob'>이동불가</span>' 카드 1장으로 교체"}, {n:1, t:"'0' 카드 1장을 '+1 <span class='icon wound'>부상</span>' 카드 1장으로 교체"}],
    "철거전문가": [{n:1, t:"'0' 카드 4장을 제거"}, {n:2, t:"'-1' 카드 2장을 제거"}, {n:1, t:"'-2' 카드 1장 및 '+1' 카드 1장을 제거"}, {n:2, t:"'0' 카드 1장을 '+2 <span class='icon status'>혼란</span>' 카드 1장으로 교체"}, {n:2, t:"'-1' 카드 1장을 '+0 <span class='icon poison'>중독</span>' 카드 1장으로 교체"}, {n:2, t:"'+2' 카드 1장을 추가"}, {n:2, t:"'+1' 카드 1장을 '+2 <span class='icon earth'>땅</span>' 카드 1장으로 교체"}, {n:2, t:"'+1' 카드 1장을 '+2 <span class='icon fire'>불</span>' 카드 1장으로 교체"}, {n:2, t:"'0' 인접한 모든 적 피해 1 카드 1장 추가"}],
    "공허감시자": [{n:1, t:"'-1' 카드 2장을 제거"}, {n:1, t:"'-2' 카드 1장을 제거"}, {n:2, t:"'0' 카드 1장을 '+1 <span class='icon dark'>어둠</span>' 카드 1장으로 교체"}, {n:2, t:"'0' 카드 1장을 '+1 <span class='icon ice'>냉기</span>' 카드 1장으로 교체"}, {n:2, t:"'-1' 카드 1장을 '+0 [치유 1 <span class='icon heal'>♥</span> 아군]' 카드 1장으로 교체"}, {n:3, t:"'+1 [치유 1 <span class='icon heal'>♥</span> 아군]' 카드 1장을 추가"}, {n:1, t:"'+1 <span class='icon poison'>중독</span>' 카드 1장을 추가"}, {n:1, t:"'+3' 카드 1장을 추가"}, {n:2, t:"'+1 <span class='icon curse'>저주</span>' 카드 1장을 추가"}]
};

// 1. 특혜 팝업 열기 및 전체 렌더링
// 1. 특혜 팝업 열기 및 전체 렌더링
function openPerkPopup() {
    const data = charData[currentJob];
    if (!data) return;
    
    // 포인트 표시
    const pDisp = document.getElementById('display-perk-points');
    if (pDisp) pDisp.innerText = data.perkPoints;
    
    renderBattleGoals(); // 배틀 골 렌더링
    renderPerkList();    // 특혜 리스트 렌더링
    
    const modal = document.getElementById('popup-perks');
    if (modal) modal.classList.add('active');
}

// 2. 배틀 골(체크박스 3개) 렌더링 및 로직
function renderBattleGoals() {
    const container = document.getElementById('battle-goal-container');
    if (!container) return;
    
    container.innerHTML = '';
    const job = charData[currentJob];
    if (!job || !job.battleGoals) return;
    
    job.battleGoals.forEach((checked, i) => {
        const box = document.createElement('div');
        box.className = `bg-box ${checked ? 'checked' : ''}`;
        box.innerText = checked ? '✔' : '';
        box.onclick = () => {
            job.battleGoals[i] = !job.battleGoals[i];
            
            // 3개 모두 달성 여부 확인
            if (job.battleGoals.every(v => v === true)) {
                job.perkPoints++;
                job.battleGoals = [false, false, false]; // 초기화
                openModal('modal-perk-success');
            }
            
            // [통합 저장] 실시간 서버 동기화
            if (typeof saveAllData === 'function') saveAllData();
            openPerkPopup(); // 화면 갱신
        };
        container.appendChild(box);
    });
}

// 3. 특혜 리스트 렌더링
function renderPerkList() {
    const container = document.getElementById('perk-list-container');
    if (!container) return;
    
    container.innerHTML = '';
    const job = charData[currentJob];
    const perks = perkData[currentJob] || [];

    if (!job.checkedPerks) {
        job.checkedPerks = {};
    }
    
    perks.forEach((perk, pIdx) => {
        const row = document.createElement('div');
        row.className = 'perk-row';
        
        const checkGroup = document.createElement('div');
        checkGroup.className = 'perk-check-container';
        
        for(let i = 0; i < perk.n; i++) {
            const dot = document.createElement('div');
            const isChecked = job.checkedPerks[pIdx + '-' + i] || false;
            dot.className = `perk-check ${isChecked ? 'checked' : ''}`;
            dot.onclick = () => togglePerk(pIdx, i);
            checkGroup.appendChild(dot);
        }

        const label = document.createElement('div');
        label.className = 'perk-text';
        label.innerHTML = perk.t;

        row.appendChild(checkGroup);
        row.appendChild(label);
        container.appendChild(row);
    });
}

// 4. 특혜 체크 토글 및 포인트 검증
function togglePerk(pIdx, i) {
    const job = charData[currentJob];
    if (!job) return;
    
    const key = pIdx + '-' + i;
    const isChecked = job.checkedPerks[key];

    if (!isChecked) {
        // 새로 체크할 때 포인트 확인
        if (job.perkPoints <= 0) {
            if (typeof showAlert === 'function') {
                showAlert("사용 가능한 특혜 포인트가 없습니다.", "포인트 부족");
            } else {
                alert("사용 가능한 특혜 포인트가 없습니다.");
            }
            return;
        }
        job.checkedPerks[key] = true;
        job.perkPoints--;
    } else {
        // 이미 체크된 것을 해제할 때
        delete job.checkedPerks[key];
        job.perkPoints++;
    }

    // [통합 저장] 실시간 서버 동기화
    if (typeof saveAllData === 'function') saveAllData();
    openPerkPopup(); // 화면 갱신
}

// 5. 포인트 수동 조절 (상단 +/- 버튼용)
function changePerkPoint(amt) {
    const job = charData[currentJob];
    if (!job) return;

    if (job.perkPoints + amt < 0) {
        if (typeof showAlert === 'function') {
            showAlert("포인트는 0보다 작을 수 없습니다.", "경고");
        }
        return;
    }
    job.perkPoints += amt;

    // [통합 저장] 실시간 서버 동기화
    if (typeof saveAllData === 'function') saveAllData();
    openPerkPopup();
}

// 디자인이 적용된 커스텀 알림/확인창
function showAlert(title, message, onConfirm = null) {
    const modal = document.getElementById('modal-common-alert');
    const titleEl = document.getElementById('alert-title');
    const msgEl = document.getElementById('alert-msg');
    
    // 1. 텍스트 설정
    titleEl.innerText = title;
    msgEl.innerHTML = message;

    // 2. 버튼 영역 초기화 (기존 버튼 싹 비우기)
    const actionArea = modal.querySelector('.modal-content');
    // 기존에 추가했던 버튼 묶음이 있다면 제거
    const oldBtns = actionArea.querySelector('.alert-button-wrap');
    if (oldBtns) oldBtns.remove();
    // HTML에 기본으로 있던 버튼도 숨기기 위해 아예 버튼 영역을 새로 만듭니다.
    const defaultBtn = actionArea.querySelector('.btn-confirm:not(.custom)');
    if (defaultBtn) defaultBtn.style.display = 'none';

    // 3. 새 버튼 컨테이너 생성
    const buttonWrap = document.createElement('div');
    buttonWrap.className = 'alert-button-wrap';
    buttonWrap.style.display = 'flex';
    buttonWrap.style.gap = '10px';
    buttonWrap.style.marginTop = '20px';

    if (onConfirm) {
        // [잠금 알림용] 진행 / 취소 버튼 구성
        buttonWrap.innerHTML = `
            <button id="alert-confirm-action" class="btn-confirm" style="flex:1; background:#ff4444;">진행</button>
            <button id="alert-cancel-action" class="btn-cancel" style="flex:1;">취소</button>
        `;
        actionArea.appendChild(buttonWrap);

        buttonWrap.querySelector('#alert-confirm-action').onclick = () => {
            onConfirm();
            closeModal('modal-common-alert');
        };
        buttonWrap.querySelector('#alert-cancel-action').onclick = () => {
            closeModal('modal-common-alert');
        };
    } else {
        // [범위해금 알림용] 확인 버튼 하나만 구성
        buttonWrap.innerHTML = `
            <button class="btn-confirm" style="width:100%;" onclick="closeModal('modal-common-alert')">확인</button>
        `;
        actionArea.appendChild(buttonWrap);
    }

    openModal('modal-common-alert');
}

/* ==========================================
   시나리오 시스템 통합 관리 (최종본)
========================================== */

// 시나리오 클릭 통합 핸들러
function handleScenarioClick(id) {
    const s = scenarioData[id];
    if (!s) return;

    if (s.state === 'locked') {
        // [잠김] 상태일 때 해금 여부 확인
        if (confirm(`[No.${id} ${s.title}] 시나리오를 해금(활성화) 하시겠습니까?`)) {
            s.state = 'active';
            renderScenarios(); // 화면 갱신
        }
    } else {
        // [활성/완료] 상태일 때는 기존처럼 완료 여부만 토글
        s.state = (s.state === 'cleared') ? 'active' : 'cleared';
        renderScenarios(); // 화면 갱신
    }
}

// 1. 시나리오 화면 그리기
function renderScenarios() {
    const container = document.getElementById('scenario-grid');
    if (!container) {
        console.error("ID가 'scenario-grid'인 엘리먼트를 찾을 수 없습니다.");
        return;
    }
    container.innerHTML = '';

    // scenarios 데이터가 없으면 실행 중단
    if (!scenarios) return;

    Object.keys(scenarios).forEach(id => {
        const s = scenarios[id];
        
        // 데이터 방어 로직
        if (!s || typeof s !== 'object' || !s.state) {
            return; 
        }

        const card = document.createElement('div');
        const isDone = s.state === 'completed';
        const isLocked = s.state === 'locked';
        
        const rewardStr = s.reward || "";
        const isItemAwarded = isDone && rewardStr.includes('#') && s.rewardOwner;
        
        card.className = `scenario-card ${s.state}`;
        
        const rewardText = isDone ? rewardStr : "<span style='color:#555;'>클리어 시 공개</span>";
        const rewardOwnerClass = isItemAwarded ? `tag-${s.rewardOwner.substring(0, 2)}` : '';

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <span style="font-size:0.8rem; color:#888; font-weight:bold; letter-spacing:1px;">SCENARIO #${id}</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    ${isDone ? 
                        `<button class="btn-reset" onclick="resetScenario(${id})" style="background:none; border:1px solid #555; color:#888; font-size:0.7rem; padding:2px 5px; cursor:pointer; border-radius:3px;">완료 취소</button>` 
                        : (!isLocked ? 
                            `<button class="btn-lock-again" onclick="requestLockScenario(${id})" style="background:none; border:1px solid #444; color:#666; font-size:0.7rem; padding:2px 5px; cursor:pointer; border-radius:3px;">다시 잠금</button>` 
                            : ''
                        )
                    }
                    <span style="font-size:0.8rem; font-weight:bold; color:${isDone ? '#2ecc71' : (isLocked ? '#444' : '#ffb84d')};">
                        ${isDone ? '✓ COMPLETED' : (isLocked ? '🔒 LOCKED' : '⚔️ AVAILABLE')}
                    </span>
                </div>
            </div>
            
            <h3 style="margin:10px 0; font-size:1.25rem; color:${isLocked ? '#444' : '#ffffff'}; text-shadow: ${isDone ? '0 0 8px rgba(255,184,77,0.4)' : 'none'};">
                ${isLocked ? '???' : s.title}
            </h3>
            
            <div style="margin-top:15px; display:flex; flex-direction:column; gap:8px;">
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; border-left:4px solid ${isDone ? '#ffcc00' : '#333'}">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <div style="font-size:0.7rem; color:#888; font-weight:bold;">🎁 클리어 보상</div>
                        ${isItemAwarded ? `<span class="owner-tag ${rewardOwnerClass}">${s.rewardOwner}</span>` : ''}
                    </div>
                    <div style="font-size:1rem; color:${isDone ? '#ffcc00' : '#555'}; font-weight:bold;">${rewardText}</div>
                </div>
                
                ${s.treasure !== "없음" && Array.isArray(s.treasure) ? `
                    <div style="display:flex; flex-direction:column; gap:6px; margin-top:4px;">
                        ${s.treasure.map(t => {
                            const isFound = isDone && t.owner && t.owner !== "미획득";
                            const treasureOwnerClass = isFound ? `tag-${t.owner.substring(0, 2)}` : '';
                            const boxLabel = t.id ? `보물상자 #${t.id}` : `💰 숨겨진 보물`;
                            const displayText = isFound ? t.content : (isDone ? "<span style='color:#555;'>미획득</span>" : "<span style='color:#555;'>???</span>");

                            return `
                                <div style="background:rgba(255,255,255,0.03); padding:8px 10px; border-radius:6px; border-left:4px solid ${isFound ? '#4a90e2' : '#333'}; display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-size:0.7rem; color:#888; font-weight:bold; margin-bottom:2px;">${boxLabel}</div>
                                        <div style="font-size:0.95rem; color:${isFound ? '#4a90e2' : '#555'}; font-weight:bold;">${displayText}</div>
                                    </div>
                                    ${isFound ? `<span class="owner-tag ${treasureOwnerClass}" style="margin:0;">${t.owner}</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            </div>

            <div style="margin-top:20px;">
                ${s.state === 'unlocked' ? 
                    `<button class="btn-confirm" style="width:100%; background:#8b4513; border:1px solid #ffb84d; padding:12px; font-weight:bold; cursor:pointer; color:white; border-radius:6px;" 
                               onclick="confirmClear(${id})">시나리오 클리어</button>` 
                    : ''
                }
                ${isLocked ? 
                    `<button class="btn-unlock" style="width:100%; background:rgba(255,255,255,0.05); border:1px solid #444; padding:12px; font-weight:bold; cursor:pointer; color:#888; border-radius:6px; transition:0.2s;" 
                               onclick="unlockScenario(${id})">🔒 시나리오 해금하기</button>` 
                    : ''
                }
            </div>
        `;
        container.appendChild(card);
    }); // <--- forEach 닫기
} // <--- function 닫기



/**
 * [추가 기능] 잠긴 시나리오를 수동으로 해금하는 함수
 */
function unlockScenario(id) {
    const s = scenarios[id];
    if (!s) return;

    // 1. 모달 텍스트 업데이트 (기존 알림창 스타일)
    const infoText = document.getElementById('unlock-confirm-text');
    infoText.innerHTML = `
        <span style="color:#888; font-size:0.8rem;">SCENARIO #${id}</span><br>
        <b style="font-size:1.1rem; color:white;">${s.title || '???'}</b><br><br>
        이 시나리오를 새로운 여정으로<br>추가하시겠습니까?
    `;

    // 2. 확인 버튼 이벤트 및 스타일 복구
    const confirmBtn = document.getElementById('btn-unlock-execute');
    
    // [보완] 해금이니까 버튼 배경색을 포인트 컬러(var(--accent))로 설정
    confirmBtn.style.background = "var(--accent)"; 
    confirmBtn.innerText = "확인";

    confirmBtn.onclick = function() {
        scenarios[id].state = 'unlocked';
        
        // 데이터 저장
        if (typeof saveCharData === 'function') saveCharData();
        
        closeModal('modal-unlock-confirm');
        renderScenarios(); // 시나리오 목록 새로고침
    };

    // 3. 모달 열기
    openModal('modal-unlock-confirm');
}

function requestLockScenario(id) {
    const s = scenarios[id];
    if (!s) return;

    const infoText = document.getElementById('unlock-confirm-text');
    // 기존 해금 모달의 UI를 재활용하되 텍스트만 변경
    infoText.innerHTML = `<span style="color:#ff4444; font-size:0.8rem;">SCENARIO #${id}</span><br><b style="font-size:1.1rem; color:white;">${s.title}</b><br><br>다시 잠금(LOCKED) 상태로 되돌릴까요?`;

    const confirmBtn = document.getElementById('btn-unlock-execute');
    confirmBtn.onclick = function() {
        scenarios[id].state = 'locked';
        if (typeof saveCharData === 'function') saveCharData();
        closeModal('modal-unlock-confirm');
        renderScenarios();
    };

    openModal('modal-unlock-confirm');
}

// 시나리오 클리어 전 커스텀 모달로 확인하는 함수
function confirmClear(id) {
    const s = scenarios[id];
    const modal = document.getElementById('modal-scenario-manage');
    const msgArea = document.getElementById('manage-msg');
    const confirmBtn = document.getElementById('btn-manage-confirm');
    const titleArea = document.getElementById('manage-title');

    if (!modal || !msgArea || !confirmBtn) return;

    // 1. 모달 제목 및 내용 설정 (클리어용 디자인)
    if (titleArea) titleArea.innerText = "⚔️ 시나리오 완료 확인";
    confirmBtn.innerText = "클리어 완료";
    confirmBtn.style.background = "#2e7d32"; // 확인 버튼을 초록색으로

    msgArea.innerHTML = `
        <div style="background: #1e2a1e; padding: 15px; border-radius: 8px; border: 1px solid #2e7d32; color: #e8f5e9; text-align: center;">
            <b style="font-size: 1.1rem; color: #4caf50;">[${s.title}]</b><br>
            이 시나리오를 완료 처리하시겠습니까?<br>
            <p style="font-size: 0.85rem; color: #a5d6a7; margin-top: 10px; line-height: 1.4;">
                ※ 보상이 즉시 공개되며,<br>
                연결된 다음 시나리오와 아이템이 해금됩니다.
            </p>
        </div>
    `;

    // 2. 확인 버튼 클릭 시 동작 (실제 클리어 실행)
    confirmBtn.onclick = function() {
        closeModal('modal-scenario-manage');
        processClear(id); // 기존의 클리어 처리 함수 호출
    };

    // 3. 모달 열기
    modal.classList.remove('hidden');
}

function processClear(id) {
    const s = scenarios[id];
    console.log("시나리오 데이터:", s);
    console.log("보물상자 데이터:", s.treasure);
    console.log("보물상자 타입:", typeof s.treasure, "배열여부:", Array.isArray(s.treasure));
    if (!s) return;

    // [1. 상태 변경 및 해금/잠금] 기존 로직 유지
    if (s.state !== 'completed') {
        s.state = 'completed';
        
        if (s.next) {
            s.next.forEach(nId => {
                if (scenarios[nId] && scenarios[nId].state === 'locked') scenarios[nId].state = 'unlocked';
            });
        }

        if (s.locks && Array.isArray(s.locks)) {
            s.locks.forEach(lId => {
                if (scenarios[lId]) {
                    scenarios[lId].state = 'locked';
                    console.log(`[상호 잠금] #${id} 클리어로 인해 #${lId} 시나리오가 잠겼습니다.`);
                }
            });
        }

        if (s.unlockItem) {
            const items = Array.isArray(s.unlockItem) ? s.unlockItem : [s.unlockItem];
            items.forEach(itemId => {
                if (typeof unlockedItemIds !== 'undefined' && !unlockedItemIds.includes(itemId)) {
                    unlockedItemIds.push(itemId);
                }
            });
        }
    }

    const modal = document.getElementById('modal-trade-select');
    const listArea = document.getElementById('trade-job-list');
    const infoArea = document.getElementById('trade-item-info');

    // [2. 체크 A] 시나리오 보상 아이템(#) 소유주 결정
    const rewardItemMatch = s.reward.match(/#(\d+)/);
    if (rewardItemMatch && !s.rewardOwner) {
        infoArea.innerHTML = `<span style="color:#ffd700; font-size:1.2rem;">🎁 시나리오 보상 아이템 획득! (${rewardItemMatch[0]})</span>`;
        setupOwnerButtons(id, (job) => { s.rewardOwner = job; });
        return; 
    }

 // [3. 체크 B] 보물 상자 연쇄 소유주 결정 (메시지 수정)
    if (Array.isArray(s.treasure)) {
        
        const pendingTreasure = s.treasure.find(t => !t.owner || t.owner === null);
        if (pendingTreasure) {
            const boxTitle = pendingTreasure.id ? `보물상자 #${pendingTreasure.id}` : `숨겨진 보물`;
            
            // [수정] content를 보여주지 않고 번호와 아이콘만 강조합니다.
            infoArea.innerHTML = `
                <div style="text-align:center; padding: 10px 0;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">🎁</div>
                    <span style="color:#4a90e2; font-size:1.1rem; font-weight:bold; letter-spacing:1px;">${boxTitle} 발견!</span><br>
                    <div style="margin-top:10px; padding: 15px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px dashed #4a90e2;">
                        <span style="color:#aaa; font-size:0.9rem;">상자 안에 무엇이 들어있을까요?</span><br>
                        <span style="color:#fff; font-size:1rem; font-weight:bold;">획득할 캐릭터를 선택해주세요.</span>
                    </div>
                </div>
            `;
            setupOwnerButtons(id, (job) => { pendingTreasure.owner = job; }, true);
            return; 
        }
    }

    // [4. 최종 단계] 모든 보물 주인이 결정되면 정산
    showFinalClearAlert(id);

    // --- 내부 도우미 함수 ---
    function setupOwnerButtons(scenarioId, assignFunc, isTreasure = false) {
        listArea.innerHTML = '';
        Object.keys(charData).forEach(job => {
            const isCreated = charData[job].playerName && charData[job].playerName.trim() !== "";
            const btn = document.createElement('button');
            btn.className = 'btn-confirm';
            btn.style.marginBottom = '8px';
            btn.innerText = isCreated ? job : `${job} (미생성)`;
            
            if (isCreated) {
                btn.onclick = () => { 
                    assignFunc(job); 
                    closeModal('modal-trade-select'); 
                    // 0.1초 뒤에 다시 실행하여 다음 보물(있을 경우)을 체크합니다.
                    setTimeout(() => processClear(scenarioId), 100); 
                };
            } else {
                btn.style.opacity = "0.5"; btn.style.cursor = "not-allowed";
            }
            listArea.appendChild(btn);
        });

        if (isTreasure) {
            const skipBtn = document.createElement('button');
            skipBtn.className = 'btn-cancel'; skipBtn.style.width = '100%';
            skipBtn.innerText = "획득 포기";
            skipBtn.onclick = () => { 
                // 현재 주인이 없는 첫 번째 상자를 찾아 '미획득' 처리
                const currentTreasure = s.treasure.find(t => !t.owner || t.owner === null);
                if (currentTreasure) currentTreasure.owner = "미획득"; 
                closeModal('modal-trade-select'); 
                setTimeout(() => processClear(scenarioId), 100); 
            };
            listArea.appendChild(skipBtn);
        }
        modal.classList.remove('hidden');
    }
}

function showFinalClearAlert(id) {
    const s = scenarios[id];
    const activeChars = Object.keys(charData).filter(j => charData[j].playerName && charData[j].playerName.trim() !== "");

    console.log(`--- [시나리오 #${id}] 정산 시작 ---`);
    
    // 알림창에 상세 내역을 띄우기 위한 변수 추가
    let rewardSummary = "🎊 모든 보상이 캐릭터에게 지급되었습니다.<br>";
    let treasureSummary = "";

    // --- 1. 시나리오 공통 보상 정산 ---
    const rGold = s.reward.match(/(\d+)(?:골드|G)/i);
    if (rGold) {
        const goldAmt = parseInt(rGold[1]);
        activeChars.forEach(j => charData[j].gold += goldAmt);
    }
    
    const rExp = s.reward.match(/(\d+)\s*(?:경험치|EXP)/i);
    if (rExp) {
        const expAmt = parseInt(rExp[1]);
        activeChars.forEach(j => charData[j].exp += expAmt);
    }

    const rPerk = s.reward.match(/(\d+)\s*(?:특혜|perk|체크|point)/i);
    if (rPerk) {
        const perkAmt = parseInt(rPerk[1]);
        activeChars.forEach(j => {
            if (charData[j].perkPoints === undefined) charData[j].perkPoints = 0;
            charData[j].perkPoints += perkAmt;
        });
    }

    // --- 2. 시나리오 보상 아이템 지급 (s.rewardOwner) ---
    const rItemMatch = s.reward.match(/#(\d+)/);
    if (rItemMatch && s.rewardOwner && charData[s.rewardOwner]) {
        addItemToChar(s.rewardOwner, parseInt(rItemMatch[1]));
    }

    // --- [수정] 3. 보물 상자 보상 정산 (배열 순회) ---
    if (Array.isArray(s.treasure)) {
        s.treasure.forEach(t => {
            if (t.owner && t.owner !== "미획득" && charData[t.owner]) {
                const tChar = charData[t.owner];
                const tText = String(t.content); 
                
                console.log(`보물상자 #${t.id} 지급 대상: ${t.owner}`);
                
                // 알림창에 표시할 보물 정보 수집
                treasureSummary += `<div style="color:#ffd700; font-size:0.8rem;">🎁 [상자 #${t.id}] ${t.owner}: ${t.content}</div>`;
                
                // 보물상자 골드
                const tGold = tText.match(/(\d+)(?:골드|G)/i);
                if (tGold) tChar.gold += parseInt(tGold[1]);
                
                // 보물상자 코인
                const tCoinMatch = tText.match(/🪙[xX*]?(\d+)/);
                if (tCoinMatch) {
                    tChar.gold += (parseInt(tCoinMatch[1]) * 2);
                } else {
                    const coins = tText.match(/🪙/g);
                    if (coins) tChar.gold += (coins.length * 2);
                }

                // 보물상자 경험치
                const tExp = tText.match(/(\d+)\s*(?:경험치|EXP)/i);
                if (tExp) tChar.exp += parseInt(tExp[1]);

                // 보물상자 특혜
                const tPerk = tText.match(/(\d+)\s*(?:특혜|perk|체크|point)/i);
                if (tPerk) {
                    if (tChar.perkPoints === undefined) tChar.perkPoints = 0;
                    tChar.perkPoints += parseInt(tPerk[1]);
                }

                // 보물상자 아이템
                const tItem = tText.match(/#(\d+)/);
                if (tItem) addItemToChar(t.owner, parseInt(tItem[1]));
            }
        });
    }

    function addItemToChar(job, itemId) {
        const idNum = Number(itemId);
        if (!charData[job].inventory) charData[job].inventory = [];
        if (!charData[job].inventory.includes(idNum)) {
            charData[job].inventory.push(idNum);
            console.log(`아이템 지급: ${job}에게 #${idNum}`);
        }
    }

    // --- 4. 데이터 저장 및 UI 즉시 반영 ---
    
    // [중요] 알림창 내용을 먼저 구성 (보물상자 요약 포함)
    if (treasureSummary) {
        rewardSummary += `<div style="margin-top:8px; border-top:1px solid #555; padding-top:5px;">${treasureSummary}</div>`;
    }
    
    document.getElementById('alert-title').innerText = `SCENARIO #${id} CLEAR`;
    document.getElementById('alert-msg').innerHTML = rewardSummary;
    document.getElementById('modal-common-alert').classList.remove('hidden');

    // 그 다음 저장 (saveAllData 내부에서 파이어베이스 전송이 일어나야 함)
    saveAllData();
    renderScenarios();

    if (typeof currentJob !== 'undefined' && charData[currentJob]) {
        const c = charData[currentJob];
        const gIn = document.getElementById('gold-input') || document.getElementById('input-gold');
        const eIn = document.getElementById('exp-input') || document.getElementById('input-exp');
        if (gIn) gIn.value = c.gold;
        if (eIn) eIn.value = c.exp;

        const pDisp = document.getElementById('display-perk-points') || 
                      document.getElementById('perk-points-display') || 
                      document.getElementById('perk-count');
        if (pDisp) pDisp.innerText = c.perkPoints || 0;

        if (typeof updateGoldDisplay === 'function') updateGoldDisplay();
        if (typeof updateExpBar === 'function') updateExpBar();
    }
    
    if (typeof renderBagItems === 'function') renderBagItems('전체');
    if (typeof renderShopItems === 'function') renderShopItems('전체');

    console.log(`--- 정산 완료 ---`);
}


function resetScenario(id) {
    const s = scenarios[id];
    const modal = document.getElementById('modal-scenario-manage');
    const msgArea = document.getElementById('manage-msg');
    const confirmBtn = document.getElementById('btn-manage-confirm');
    const titleArea = document.getElementById('manage-title');

    if (!modal || !msgArea || !confirmBtn) return;

    if (titleArea) titleArea.innerText = "⚠️ 상태 변경 알림";
    confirmBtn.innerText = "변경 확인";
    confirmBtn.style.background = "#c0392b"; 

    let itemNo = s.unlockItem; 
    if (!itemNo && s.reward) {
        const match = s.reward.match(/#(\d+)/);
        if (match) itemNo = parseInt(match[1]);
    }

    msgArea.innerHTML = `
        <div style="background: #3d1a1a; padding: 15px; border-radius: 8px; border: 1px solid #632a2a; color: #ffcccc; text-align: center;">
            <b style="font-size: 1.1rem; color: #ff4d4d;">[${s.title}]</b><br>
            완료 상태를 취소하시겠습니까?<br>
            <p style="font-size: 0.85rem; color: #a38888; margin-top: 10px; line-height: 1.4;">
                ※ <b style="color:#ff9999;">데이터 회수 가동:</b><br>
                - 지급된 골드, 경험치, 특혜 및 <b style="color:#ffd700;">모든 보물 보상</b> 차감<br>
                - 캐릭터 가방에서 #${itemNo || '??'} 삭제<br>
                - 상점 해금 및 다음 시나리오 잠금
            </p>
        </div>
    `;

    confirmBtn.onclick = function() {
        s.state = 'unlocked';
        
        const activeChars = Object.keys(charData).filter(j => charData[j].playerName && charData[j].playerName.trim() !== "");

        // 1. 공통 시나리오 보상 회수
        const rGold = s.reward.match(/(\d+)(?:골드|G)/i);
        if (rGold) {
            const goldAmt = parseInt(rGold[1]);
            activeChars.forEach(j => charData[j].gold = Math.max(0, charData[j].gold - goldAmt));
        }

        const rExp = s.reward.match(/(\d+)\s*(?:경험치|EXP)/i);
        if (rExp) {
            const expAmt = parseInt(rExp[1]);
            activeChars.forEach(j => charData[j].exp = Math.max(0, charData[j].exp - expAmt));
        }

        const rPerk = s.reward.match(/(?:특혜|perk)\s*[+]*(\d+)|(\d+)\s*(?:특혜|perk)/i);
        if (rPerk) {
            const perkAmt = parseInt(rPerk[1] || rPerk[2]);
            activeChars.forEach(j => {
                if (charData[j].perkPoints !== undefined) {
                    charData[j].perkPoints = Math.max(0, charData[j].perkPoints - perkAmt);
                }
            });
        }

        // [수정] 2. 보물 상자 보상 회수 (배열 순회 방식)
        if (Array.isArray(s.treasure)) {
            s.treasure.forEach(t => {
                if (t.owner && t.owner !== "미획득" && charData[t.owner]) {
                    const tChar = charData[t.owner];
                    const tText = String(t.content);

                    // 골드 회수
                    const tGoldMatch = tText.match(/(\d+)(?:골드|G)/i);
                    if (tGoldMatch) tChar.gold = Math.max(0, tChar.gold - parseInt(tGoldMatch[1]));

                    // 코인 회수
                    let coinGoldAmt = 0;
                    const tCoinQtyMatch = tText.match(/🪙[xX*]?(\d+)/);
                    if (tCoinQtyMatch) {
                        coinGoldAmt = parseInt(tCoinQtyMatch[1]) * 2;
                    } else {
                        const coins = tText.match(/🪙/g);
                        if (coins) coinGoldAmt = coins.length * 2;
                    }
                    tChar.gold = Math.max(0, tChar.gold - coinGoldAmt);

                    // 경험치 회수
                    const tExpMatch = tText.match(/(\d+)\s*(?:경험치|EXP)/i);
                    if (tExpMatch) tChar.exp = Math.max(0, tChar.exp - parseInt(tExpMatch[1]));

                    // 특혜 회수
                    const tPerkMatch = tText.match(/(\d+)\s*(?:특혜|perk|체크|point)/i);
                    if (tPerkMatch && tChar.perkPoints !== undefined) {
                        tChar.perkPoints = Math.max(0, tChar.perkPoints - parseInt(tPerkMatch[1]));
                    }
                    
                    // 아이템 회수
                    const tItemMatch = tText.match(/#(\d+)/);
                    if (tItemMatch && tChar.inventory) {
                        const tItemId = parseInt(tItemMatch[1]);
                        tChar.inventory = tChar.inventory.filter(id => id !== tItemId);
                    }
                }
                // 보물 주인 데이터 초기화 (null로 복구)
                t.owner = null;
            });
        }

        // 3. 아이템 및 소유권 관리
        if (itemNo) {
            const targetId = parseInt(itemNo);
            const itemInMaster = itemData.find(i => i.id === targetId);
            if (itemInMaster) { itemInMaster.owners = []; }

            Object.values(charData).forEach(char => {
                if (char.inventory && Array.isArray(char.inventory)) {
                    char.inventory = char.inventory.filter(itemId => parseInt(itemId) !== targetId);
                }
            });

            if (typeof unlockedItemIds !== 'undefined') {
                unlockedItemIds = unlockedItemIds.filter(id => parseInt(id) !== targetId);
            }
        }
        
        s.rewardOwner = null;
        s.treasureOwner = null; // (기존 필드도 초기화)

        // 연결된 시나리오 관리
        if (s.next && Array.isArray(s.next)) {
            s.next.forEach(nId => {
                if (scenarios[nId]) scenarios[nId].state = 'locked';
            });
        }
        if (s.locks && Array.isArray(s.locks)) {
            s.locks.forEach(lId => {
                if (scenarios[lId] && scenarios[lId].state === 'locked') {
                    scenarios[lId].state = 'unlocked';
                }
            });
        }
        
        closeModal('modal-scenario-manage');
        
        // 4. UI 즉시 반영
        if (typeof currentJob !== 'undefined' && charData[currentJob]) {
            const c = charData[currentJob];
            const gIn = document.getElementById('gold-input') || document.getElementById('input-gold');
            const eIn = document.getElementById('exp-input') || document.getElementById('input-exp');
            const pDisp = document.getElementById('display-perk-points') || document.getElementById('perk-count-display') || document.getElementById('perk-count');
            if (gIn) gIn.value = c.gold;
            if (eIn) eIn.value = c.exp;
            if (pDisp) pDisp.innerText = c.perkPoints;
        }

        renderScenarios();
        if (typeof updateGoldDisplay === 'function') updateGoldDisplay();
        if (typeof updateExpBar === 'function') updateExpBar();
        if (typeof renderShopItems === 'function') renderShopItems('전체');
        if (typeof renderBagItems === 'function') renderBagItems('전체');
        
        saveAllData(); 
    };

    modal.classList.remove('hidden');
}

// 5. 유틸리티 및 데이터 관리
function closeModal(modalId) {
    const m = document.getElementById(modalId);
    if (m) m.classList.add('hidden');
}

function showRewardModal(title, rewardHtml) {
    const modal = document.getElementById('reward-modal');
    const body = document.getElementById('modal-body');
    if (!modal || !body) return;

    body.innerHTML = `
        <h2 style="color:#1b5e20; margin-top:0;">🎊 시나리오 완료!</h2>
        <p style="font-size:1.1rem; color:#fff;"><b>${title}</b></p>
        <div style="margin:20px 0;">
            ${rewardHtml}
        </div>
        <button onclick="closeRewardModal()" style="background:#2e7d32; color:white; border:none; padding:12px 30px; border-radius:5px; cursor:pointer; font-weight:bold;">확인</button>
    `;
    modal.style.display = 'flex';
}

function closeRewardModal() {
    const modal = document.getElementById('reward-modal');
    if (modal) modal.style.display = 'none';
}

function saveAllData() {
    if (currentPartyIndex !== null && parties[currentPartyIndex]) {
        // [수정] 로컬 업데이트 시작됨을 표시
        isLocalUpdate = true;

        // 1. 로컬 변수 데이터 동기화
        parties[currentPartyIndex].characters = charData;
        parties[currentPartyIndex].scenarios = scenarios;
        parties[currentPartyIndex].unlockedItemIds = unlockedItemIds;

        // 2. 브라우저 백업 (기존 로직)
        localStorage.setItem('gloomhaven_parties', JSON.stringify(parties));

        // 3. [추가] 실시간 서버(Firebase) 저장
        if (typeof database !== 'undefined') {
            database.ref('parties/' + currentPartyIndex).set(parties[currentPartyIndex])
                .then(() => {
                    console.log("서버 동기화 성공!");
                    // [수정] 저장이 완료되고 서버 응답을 받은 후, 잠시 뒤에 플래그 해제
                    setTimeout(() => { isLocalUpdate = false; }, 500);
                })
                .catch((error) => {
                    console.error("서버 저장 실패:", error);
                    isLocalUpdate = false;
                });
        }
        
        console.log(`[${parties[currentPartyIndex].partyName}] 파티 데이터 통합 저장됨.`);
    } else {
        localStorage.setItem('gloomhaven_scenarios', JSON.stringify(scenarios));
    }
}


// [1. 데이터 초기화] 카드 범위를 1~22로 강제 제한
let cityEventState = (function() {
    const saved = JSON.parse(localStorage.getItem('cityEventState')) || {};
    
    // 초기 데이터가 없을 때 1~8번까지만 기본값으로 설정
    let active = saved.active || [1, 2, 3, 4, 5, 6, 7, 8];
    
    // 혹시 22번을 넘는 숫자가 저장되어 있다면 필터링
    active = active.filter(n => n <= 22);
    const removed = (saved.removed || []).filter(n => n <= 22);
    
    return { active, removed, logs: saved.logs || [] };
})();

// [2. 커스텀 알림창 함수] (기본 alert/confirm 대체)
function showEventNotify(message, isConfirm = false, onConfirm = null) {
    // 기존에 알림창이 있다면 제거
    const oldNotify = document.getElementById('event-notify');
    if (oldNotify) oldNotify.remove();

    const notify = document.createElement('div');
    notify.id = 'event-notify';
    notify.style = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #252525; border: 1px solid var(--accent); border-radius: 12px;
        padding: 20px; z-index: 10000; width: 280px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: #fff; font-size: 0.9rem;
    `;
    
    let buttons = `<button onclick="this.parentElement.remove()" style="background:var(--accent); color:#fff; border:none; padding:8px 20px; border-radius:5px; cursor:pointer; margin-top:15px; font-weight:bold;">확인</button>`;
    
    if (isConfirm) {
        buttons = `
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button id="notify-ok" style="background:var(--accent); color:#fff; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">삭제</button>
                <button onclick="this.parentElement.parentElement.remove()" style="background:#444; color:#fff; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">취소</button>
            </div>
        `;
    }

    notify.innerHTML = `<div>${message}</div>${buttons}`;
    document.body.appendChild(notify);

    if (isConfirm && onConfirm) {
        document.getElementById('notify-ok').onclick = () => {
            onConfirm();
            notify.remove();
        };
    }
}

// [3. 화면 렌더링]
function renderCityEventContent() {
    // 여기서 length: 22를 확인하세요! (30 -> 22 수정)
    const allIds = Array.from({length: 22}, (_, i) => i + 1);
    const { active, removed, logs } = cityEventState;
    const locked = allIds.filter(id => !active.includes(id) && !removed.includes(id));

    const draw = (elId, list, color, border) => {
        const el = document.getElementById(elId);
        if (!el) return;
        el.innerHTML = list.sort((a,b)=>a-b).map(n => 
            `<span onclick="setEventId(${n})" style="background:#111; color:${color}; border:1px solid ${border}; padding:2px 6px; border-radius:4px; font-size:0.75rem; font-weight:bold; font-family:monospace; cursor:pointer;">${n}</span>`
        ).join('') || '<span style="color:#444; font-size:0.7rem;">없음</span>';
        
        const countEl = document.getElementById(elId.replace('-numbers', '-count'));
        if (countEl) countEl.innerText = `(${list.length}장)`;
    };

    draw('deck-numbers', active, '#ffd700', '#444');
    draw('removed-numbers', removed, '#ff6b6b', '#c0392b');
    draw('locked-numbers', locked, '#555', '#333');

    // 로그 렌더링 (X버튼 반영)
    const latestBox = document.getElementById('latest-log-container');
    const allBox = document.getElementById('all-logs-container');
    
    const logHtml = (log, index) => `
        <div class="scenario-card completed" style="position:relative; margin-bottom:6px; padding:10px; border-left:4px solid ${log.type === '영구 소멸' ? '#c0392b' : (log.type === '카드 잠금' ? '#555' : '#2980b9')}; background:#222;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="color:#fff; font-size:0.85rem;">#${log.id} ${log.type}</b>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="color:#555; font-size:0.7rem;">${log.date}</span>
                    <span onclick="deleteLog(${index})" style="color:#ff6b6b; cursor:pointer; font-weight:bold; font-size:1.1rem; padding:0 5px;">×</span>
                </div>
            </div>
            <div style="color:#999; font-size:0.8rem; margin-top:4px;">${log.note}</div>
        </div>`;

    if (latestBox) latestBox.innerHTML = logs.length ? logHtml(logs[0], 0) : '<div style="color:#444; text-align:center; font-size:0.8rem; padding:15px;">기록이 없습니다.</div>';
    if (allBox) allBox.innerHTML = logs.map((l, i) => logHtml(l, i)).join('');
}

// [4. 주요 기능 함수들]
function setEventId(id) {
    document.getElementById('input-event-id').value = id;
}

function deleteLog(index) {
    showEventNotify("이 기록을 삭제하시겠습니까?", true, () => {
        cityEventState.logs.splice(index, 1);
        saveAndRender();
    });
}

function handleEventAction(action) {
    const idInput = document.getElementById('input-event-id');
    const id = parseInt(idInput.value);
    if (isNaN(id) || id < 1 || id > 22) return showEventNotify("⚠️ 1~22 사이의 번호를 입력하세요.");

    const note = document.getElementById('input-event-note').value.trim() || "기록 없음";
    let type = "";

    if (action === 'toggle') {
        if (cityEventState.active.includes(id)) {
            cityEventState.active = cityEventState.active.filter(n => n !== id);
            type = "카드 잠금";
        } else {
            cityEventState.active.push(id);
            cityEventState.removed = cityEventState.removed.filter(n => n !== id);
            type = "카드 해금";
        }
    } else if (action === 'remove') {
        cityEventState.active = cityEventState.active.filter(n => n !== id);
        if (!cityEventState.removed.includes(id)) cityEventState.removed.push(id);
        type = "영구 소멸";
    } else if (action === 'bottom') {
        if (!cityEventState.active.includes(id)) cityEventState.active.push(id);
        cityEventState.removed = cityEventState.removed.filter(n => n !== id);
        type = "덱 복귀";
    }

    cityEventState.logs.unshift({ date: new Date().toLocaleDateString('ko-KR', {month:'short', day:'numeric'}), id, note, type });
    idInput.value = '';
    document.getElementById('input-event-note').value = '';
    saveAndRender();
}

function saveAndRender() {
    localStorage.setItem('cityEventState', JSON.stringify(cityEventState));
    renderCityEventContent();
}

// 모드 진입 (에러 방지용 다시 선언)
function openCityEventMode() {
    if (typeof closeModal === 'function') closeModal('modal-char-sheet');
    if (typeof showScreen === 'function') showScreen('screen-city-event');
    renderCityEventContent();
}

window.onload = function() {
    database.ref('parties/').on('value', function(snapshot) {
        if (typeof isLocalUpdate !== 'undefined' && isLocalUpdate) return;

        const data = snapshot.val();
        if (!data) {
            parties = []; 
        } else {
            parties = Array.isArray(data) ? data : Object.values(data);
        }

        if (typeof renderPartyList === 'function') renderPartyList(); 

        if (currentPartyIndex !== null && parties[currentPartyIndex]) {
            // 서버에서 받은 최신 데이터로 로컬 변수 교체
            charData = parties[currentPartyIndex].characters || {};
            scenarios = parties[currentPartyIndex].scenarios || {};
            // 아이템 해금 목록도 동기화 대상에 포함
            unlockedItemIds = parties[currentPartyIndex].unlockedItemIds || [];
            
            // 1. 메인 화면의 캐릭터 카드 UI 갱신
            Object.keys(charData).forEach(job => {
                if (typeof syncJobCard === 'function') syncJobCard(job);
            });

            // 2. 현재 "상세 시트" 혹은 "팝업"이 열려있다면 실시간 갱신
            if (typeof currentJob !== 'undefined' && currentJob && charData[currentJob]) {
                const c = charData[currentJob];
                
                // 골드, 경험치, 특혜 포인트 텍스트 갱신
                const gIn = document.getElementById('gold-input') || document.getElementById('input-gold');
                const eIn = document.getElementById('exp-input') || document.getElementById('input-exp');
                const pDisp = document.getElementById('perk-count') || document.getElementById('display-perk-points');

                if (gIn && document.activeElement !== gIn) gIn.value = c.gold || 0;
                if (eIn && document.activeElement !== eIn) eIn.value = c.exp || 0;
                if (pDisp) pDisp.innerText = c.perkPoints || 0;

                // [추가] 특혜(Perk) 팝업이 활성화되어 있다면 내부 리스트 다시 그리기
                const perkModal = document.getElementById('popup-perks');
                if (perkModal && perkModal.classList.contains('active')) {
                    if (typeof renderPerkList === 'function') renderPerkList();
                    if (typeof renderBattleGoals === 'function') renderBattleGoals();
                }

                // 관련 UI(골드바, 경험치바, 가방 등) 업데이트
                if (typeof updateGoldDisplay === 'function') updateGoldDisplay();
                if (typeof updateExpBar === 'function') updateExpBar();
                if (typeof renderBagItems === 'function') renderBagItems('전체');
                // 상점이 열려있을 경우를 대비
                if (typeof renderShop === 'function') renderShop();
            }

            if (typeof renderScenarios === 'function') renderScenarios();
        }

        localStorage.setItem('gloomhaven_parties', JSON.stringify(parties));
    });
};

</script>
</body>
</html>